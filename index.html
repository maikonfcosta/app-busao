<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Calculadora ‚Äì Bus√£o (v4.0)</title>
<style>
  :root{
    --bg:#0b1022; --panel:#0f172a; --muted:#94a3b8; --text:#e5e7eb;
    --ok:#34d399; --bad:#f87171; --warn:#fbbf24; --card:#111827; --chip:#1f2937;
    --line:#233048; --line2:#1b2438; --accent:#60a5fa; --accent-2:#3b82f6;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font:15px/1.45 Inter,system-ui,Segoe UI,Roboto,Arial;background:linear-gradient(120deg,#0b1022,#171e34);color:var(--text)}

  /* ======= LAYOUT ======= */
  .wrap{display:grid;grid-template-columns:minmax(0,1fr) 420px;gap:12px;min-height:100vh;padding:12px}
  .panel{background:var(--panel);border:1px solid var(--line2);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.25);overflow:hidden}
  .panel-body{padding:12px 14px}
  header{padding:12px 14px;border-bottom:1px solid var(--line);display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  header h1{font-size:16px;margin:0;font-weight:800}
  header small{color:var(--muted)}
  .foot{padding:10px 12px;border-top:1px solid var(--line2);color:var(--muted);font-size:12px}
  .hidden{display:none}

  /* ======= NAV TABS (topo da coluna esquerda) ======= */
  .tabs-top{display:flex;gap:8px;padding:10px 12px;border-bottom:1px solid var(--line);background:linear-gradient(180deg,#0f172a,#0c1326);flex-wrap:wrap}
  .tabs-top .tabbtn{appearance:none;border:1px solid #2b3d62;background:#101b34;color:#cbd5e1;border-radius:10px;padding:8px 12px;cursor:pointer}
  .tabs-top .tabbtn.act{background:#0f2a52;border-color:var(--accent-2);color:#e6f1ff;box-shadow:0 0 0 1px var(--accent-2) inset}
  .tabview{display:none}
  .tabview.act{display:block}

  /* ======= SE√á√ïES, FORM ======= */
  .section{padding:12px 14px;border-bottom:1px dashed var(--line)}
  .section:last-child{border-bottom:0}
  label{display:block;color:var(--muted);font-size:12px;margin-bottom:6px;text-transform:uppercase;letter-spacing:.08em}
  input,select,button,textarea{font:inherit}
  input,select,textarea{width:auto;background:#0b1224;color:var(--text);border:1px solid #273046;border-radius:10px;padding:10px 12px;outline:none}
  .chips{display:flex;flex-wrap:wrap;gap:8px}
  .chip{background:var(--chip);color:#cbd5e1;padding:6px 10px;border-radius:999px;font-size:12px;border:1px solid #2b3244}
  .driver-card,.improv-card{background:var(--card);border:1px solid #283249;border-radius:12px;padding:10px}
  .drivers{display:grid;gap:8px}
  .inline{display:flex;align-items:center;gap:8px;margin-top:8px;color:#cbd5e1;font-size:13px}
  .bar{display:flex;gap:8px;flex-wrap:wrap}
  .btn{background:#13213a;border:1px solid #2b3d62;color:#e5e7eb;border-radius:10px;padding:8px 12px;cursor:pointer;transition:transform .04s ease}
  .btn:hover{transform:translateY(-1px)}
  .btn.acc{background:#12273f;border-color:#21476f}
  .btn.warn{background:#3a1f12;border-color:#6d2b19}
  .btn.ghost{background:transparent;border-color:#2b3d62}
  .btn.accent{background:#0f2a52;border-color:var(--accent-2)}
  .btn.sm{padding:4px 8px;border-radius:8px}
  .btn-pill{border-radius:999px}
  .btn-toggle{background:#101b34;border:1px solid #2b3d62}
  .btn-toggle.sel{background:#0f2a52;border-color:var(--accent-2);box-shadow:0 0 0 1px var(--accent-2) inset}

  .section-title{font:800 clamp(16px,4.5vw,22px)/1.2 Inter,system-ui;color:#e2e8f0;margin:4px 0;display:flex;align-items:center;gap:8px;justify-content:space-between}
  .section-sub{color:#93a3b8;font-size:13px;margin-bottom:10px}

  /* ======= GRID dos assentos ======= */
  .grid{padding:12px;display:grid;grid-template-columns:repeat(6,minmax(0,1fr));gap:10px}
  .seat{background:linear-gradient(180deg,#111827,#0b1222);border:1px solid #263047;border-radius:14px;min-height:auto;display:flex;flex-direction:column;gap:6px;padding:8px;position:relative;cursor:pointer}
  .seat .pos{position:absolute;top:8px;right:10px;color:#64748b;font-size:11px}
  .slot{display:flex;align-items:center;gap:6px}
  .slot-name{flex:1}
  .seat.hl{outline:2px solid var(--accent);box-shadow:0 0 0 2px var(--accent) inset, 0 0 14px rgba(96,165,250,.35)}
  @keyframes flash{from{box-shadow:0 0 0 8px rgba(96,165,250,.55) inset}to{box-shadow:0 0 0 0 rgba(96,165,250,0) inset}}
  .seat.hl{animation:flash .7s ease}
  .hidden-select{display:none !important;}

  /* ======= BUS√ÉO (Ajuda Visual) ======= */
  .bus-visual{
    --body:#f59e0b; --edge:#b45309; --window:#fff7e6; --wheel:#0f172a;
    position:relative;width:100%;max-width:900px;margin:2px auto 14px;aspect-ratio:16/7;
    background:linear-gradient(180deg,var(--body),#fbbf24 70%) padding-box, linear-gradient(180deg,var(--edge),var(--edge)) border-box;
    border:4px solid var(--edge);border-radius:28px 36px 36px 28px;box-shadow:0 8px 24px rgba(245,158,11,.25);overflow:hidden;
  }
  .bus-visual .driver{position:absolute;inset:0 auto 0 0;width:23%;background:
      radial-gradient(110% 100% at 100% 50%, transparent 65%, rgba(255,255,255,.12) 66%) left/100% 100% no-repeat,
      linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,0)) no-repeat;border-right:3px solid var(--edge)}
  .bus-visual .driver .label{position:absolute;top:.5rem;left:.65rem;font:600 12px/1.1 Inter,system-ui;color:#7c2d12;letter-spacing:.4px}
  .bus-visual .wheel{position:absolute;bottom:-34px;width:54px;height:54px;background:radial-gradient(circle at 50% 50%,#fff 0 6px,var(--wheel) 7px 100%);border-radius:50%}
  .bus-visual .wheel.w1{left:28%} .bus-visual .wheel.w2{right:14%}
  .bus-visual .seats{position:absolute;left:25%;right:4%;top:12%;bottom:18%;display:grid;grid-template-columns:repeat(6,1fr);grid-template-rows:repeat(2,1fr);gap:clamp(6px,1.6vw,14px)}
  .bus-visual .bseat{position:relative;display:grid;place-items:center;border-radius:10px;background:var(--window);border:2px solid #fef3c7;color:#7c2d12;font-weight:800;font-size:clamp(12px,2.9vw,16px);user-select:none;cursor:pointer;transition:transform .12s ease, box-shadow .12s ease, background .12s ease, border-color .12s ease}
  .bus-visual .bseat:hover, .bus-visual .bseat[aria-current="true"]{transform:translateY(-1px);box-shadow:0 6px 14px rgba(245,158,11,.25);border-color:#fde68a}
  .bus-visual .bseat.occ{background:rgba(34,197,94,.22);border-color:#86efac;color:#065f46}
  .bus-visual .bseat[data-label]::after{content:attr(data-label);position:absolute;bottom:calc(100% + 6px);left:50%;transform:translateX(-50%);white-space:nowrap;background:#7c2d12;color:#fff7e6;font-weight:700;font-size:11px;padding:4px 8px;border-radius:8px;opacity:0;pointer-events:none;transition:opacity .12s ease, transform .12s ease}
  .bus-visual .bseat:hover::after{opacity:1;transform:translateX(-50%) translateY(-2px)}
  .popover{display:none;background:#0b1220;border:1px solid #334155;color:#e2e8f0;padding:10px;border-radius:10px;margin:8px 0}
  .popover.open{display:block}

  /* ======= Resultado ======= */
  .totals{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .total{background:#0b1220;border:1px solid #263047;border-radius:12px;padding:12px}
  .total h3{margin:0 0 6px 0;font-size:13px;color:#cbd5e1}
  .total .v{font-weight:800;font-size:28px}
  .kpi.good{color:var(--ok)} .kpi.bad{color:var(--bad)} .kpi.warn{color:var(--warn)} .kpi.neu{color:var(--text)}
  .explain{padding:10px 12px;max-height:calc(100vh - 210px);overflow:auto}
  .row{border-bottom:1px dashed #263047;padding:8px 0;scroll-margin:80px}
  .row.hl{background:#0b1220;border-color:#3b82f6}
  .row:last-child{border-bottom:0}
  .row .h{display:flex;justify-content:space-between;gap:10px}
  .row .name{font-weight:700}
  .row .score{font-weight:800}
  .row .d{color:#93a3b8;font-size:13px;margin-top:6px;white-space:pre-wrap}
  .row.req .name{color:var(--warn)}  /* embarque N√ÉO permitido */
  .row.sc  .name{color:var(--warn)}  /* sem pontua√ß√£o por condi√ß√£o n√£o atendida */
  .row .d .req-badge{display:inline-block;background:rgba(251,191,36,.14);border:1px solid #fbbf24;color:#fbbf24;padding:2px 6px;border-radius:6px;font-size:11px;margin-right:6px}
  .row .d .req-text{color:#fbbf24;font-weight:700}
  .row .d .noscore-badge{display:inline-block;background:rgba(251,191,36,.14);border:1px solid #fbbf24;color:#fbbf24;padding:2px 6px;border-radius:6px;font-size:11px;margin-right:6px}
  .table-wrap{overflow:auto}

  /* ======= Cat√°logo ======= */
  .catalog{background:#0b1220;border:1px solid #263047;border-radius:12px;padding:10px;max-height:calc(100vh - 220px);overflow:auto}
  .cat-controls{display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap}
  .cat-group{margin-bottom:12px}
  .cat-group h3{margin:6px 0 8px 0;font-size:14px;color:#e2e8f0}
  .cat-item{border:1px solid #263047;background:#0b1224;border-radius:10px;padding:8px 10px;margin-bottom:8px}
  .cat-head{display:flex;justify-content:space-between;gap:8px}
  .cat-name{font-weight:800}
  .cat-pts{color:#cbd5e1}
  .cat-tags{color:#9fb0c9;font-size:12px;margin-top:3px}
  .cat-text{color:#cbd5e1;font-size:13px;margin-top:6px;white-space:pre-wrap}
  .badge{display:inline-block;border:1px solid #334155;color:#cbd5e1;background:#0e1a31;padding:2px 6px;border-radius:999px;font-size:11px;margin-right:6px}
  .badge.exp{border-color:#7c3aed;color:#e9d5ff;background:#2e1065}
  .badge.req{border-color:#fbbf24;color:#fbbf24;background:rgba(251,191,36,.12)}
  .badge.pen{border-color:#f87171;color:#fecaca;background:rgba(248,113,113,.12)}
  .badge.hab{border-color:#34d399;color:#d1fae5;background:rgba(52,211,153,.12)}
  .badge.motorista {
    border-color: #a16207;
    color: #fef3c7;
    background: rgba(161, 98, 7, 0.15);
  }
  .badge.melhoria {
    border-color: #1e40af;
    color: #dbeafe;
    background: rgba(30, 64, 175, 0.15);
  }
  .badge.perrengue {
    border-color: #dc2626;
    color: #fecaca;
    background: rgba(220, 38, 38, 0.15);
  }
  .badge.rotadiaria {
    border-color: #10b981;
    color: #d1fae5;
    background: rgba(16, 185, 129, 0.15);
  }
  .badge.pagode {
    border-color: #f59e0b;
    color: #fef3c7;
    background: rgba(245, 158, 11, 0.15);
  }
  .badge.lenda {
    border-color: #8b5cf6;
    color: #ede9fe;
    background: rgba(139, 92, 246, 0.15);
  }
  .badge.estounobusao {
    border-color: #3b82f6;
    color: #dbeafe;
    background: rgba(59, 130, 246, 0.15);
  }

  /* ======= Modal Seletor de Carta ======= */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:9999;background:rgba(2,6,23,.6)}
  .modal.open{display:flex}
  .modal-card{width:min(920px,94vw);max-height:84vh;overflow:auto;background:#0b1220;border:1px solid #334155;border-radius:14px}
  .modal-head{display:flex;align-items:center;gap:8px;justify-content:space-between;padding:10px 12px;border-bottom:1px solid #263047}
  .modal-body{padding:12px}
  .picker-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
  .picker-item{display:flex;gap:8px;align-items:center;background:#0b1224;border:1px solid #273046;border-radius:10px;padding:8px;cursor:pointer}
  .picker-item.disabled{opacity:.45;cursor:not-allowed;filter:grayscale(.3)}
  .picker-item:hover:not(.disabled){border-color:#415a8b}
  .picker-name{font-weight:700}
  .picker-tags{color:#9fb0c9;font-size:12px}
  .picker-filter{display:flex;gap:8px;margin-bottom:10px;flex-wrap:wrap}
  .pill{padding:6px 10px;border:1px solid #2b3d62;border-radius:999px;background:#101b34;color:#cbd5e1;cursor:pointer}
  .pill.act{background:#0f2a52;border-color:var(--accent-2)}

  /* ======= REGRAS & FAQ (NOVO ESTILO) ======= */
  .rules-container{padding:12px; max-height: calc(100vh - 280px); overflow-y: auto;}
  .rules-container h1, .rules-container h2, .rules-container h3{margin:0; font-weight: 800;}
  .rules-container h1{font-size: 20px; margin-bottom: 4px;}
  .rules-container h2, .rules-container h3{font-size: 16px;}
  .rules-container p, .rules-container ul{margin: 10px 0 0 0; color: var(--muted); font-size: 14px;}
  .rules-container ul{padding-left: 20px;}
  .rules-container li{margin-bottom: 6px;}
  .rules-container .quick-summary { border: 1px solid var(--line); padding: 12px; border-radius: 12px; margin-top: 14px; background: #0c1326; }
  .rules-container .attention { border-left: 3px solid var(--warn); padding: 10px 12px; background: rgba(251,191,36,.08); border-radius: 0 8px 8px 0; margin-top: 14px;}
  .rules-container details{border-bottom: 1px solid var(--line); margin-top:12px;}
  .rules-container details:last-of-type{border-bottom:0;}
  .rules-container summary { cursor: pointer; padding: 12px 8px; list-style: none; display: flex; justify-content: space-between; align-items: center; }
  .rules-container summary::-webkit-details-marker { display: none; }
  .rules-container summary:hover h2, .rules-container summary:hover h3 {color: var(--accent);}
  .rules-container summary::after {
    content: '‚ñº';
    font-size: 14px;
    transition: transform 0.2s ease;
  }
  .rules-container details[open] > summary::after { transform: rotate(180deg); }
  .rules-container details .rule-content-body { padding: 4px 12px 16px 12px; }
  .expansion { margin-top: 20px; border-top: 1px solid var(--line); padding-top: 10px;}
  .expansion > h2 { font-size: 18px; margin-bottom: 10px;}

  /* ======= Responsividade ======= */
  @media (max-width:1080px){
    .wrap{grid-template-columns:1fr}
    .explain{max-height:unset}
  }
  @media (max-width:720px){
    .grid{grid-template-columns:repeat(3,1fr)}
    .picker-grid{grid-template-columns:1fr}
  }
  @media (max-width:600px){
    .totals{grid-template-columns:1fr}
  }
  @media (max-width:430px){
    .grid{grid-template-columns:repeat(2,1fr)}
    header h1{font-size:15px}
    .total .v{font-size:24px}
  }
  @media (max-width:350px){
    .grid{grid-template-columns:1fr}
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="panel" id="leftPanel">
    <header><h1>Bus√£o ‚Äì Calculadora</h1></header>

    <div class="tabs-top">
      <button class="tabbtn act" data-tab="tab-config">Configura√ß√£o</button>
      <button class="tabbtn" data-tab="tab-seats">Assentos</button>
      <button class="tabbtn" data-tab="tab-catalog">Cat√°logo</button>
      <button class="tabbtn" data-tab="tab-regrasfaq">Regras & FAQ</button>
    </div>

    <div class="tabview act" id="tab-config">
      <div class="section">
        <label>Jogador</label>
        <input id="playerName" placeholder="Nome do jogador" />
      </div>

      <div class="section">
        <label>Motorista</label>
        <select id="driver"></select>
        <div id="driverInfo" class="drivers" style="margin-top:10px"></div>
        <div class="inline">
          <input type="checkbox" id="expCobradores" />
          <label for="expCobradores" style="margin:0">Ativar Expans√£o COBRADORES üí∂</label>
        </div>
        <div class="inline">
          <input type="checkbox" id="expApaixonados" />
          <label for="expApaixonados" style="margin:0">Ativar Expans√£o: Os Apaixonados üíò</label>
        </div>
        <div class="inline">
          <input type="checkbox" id="expPerrengues" />
          <label for="expPerrengues" style="margin:0">Ativar Expans√£o: Perrengues ‚ö†Ô∏è</label>
        </div>
        <div class="inline">
          <input type="checkbox" id="expEstouNoBusao" />
          <label for="expEstouNoBusao" style="margin:0">Ativar Expans√£o: Estou no bus√£o üëç</label>
        </div>
        <div class="inline">
          <input type="checkbox" id="expLendasUrbanas" />
          <label for="expLendasUrbanas" style="margin:0">Ativar Expans√£o: Lendas Urbanas üëª</label>
        </div>
        <div class="inline">
          <input type="checkbox" id="expGrupoPagode" />
          <label for="expGrupoPagode" style="margin:0">Ativar Expans√£o: Grupo de Pagode üéµ</label>
        </div>
        <div class="inline">
          <input type="checkbox" id="expRotasDiarias" />
          <label for="expRotasDiarias" style="margin:0">Ativar Expans√£o: Rotas Di√°rias üöå</label>
        </div>
      </div>

      <div class="section">
        <label>Melhorias do Bus√£o (at√© 3, sem repetir)</label>
        <div id="improvButtons" class="bar" style="flex-wrap:wrap"></div>
        <div id="improvInfo" class="drivers" style="margin-top:10px"></div>
        <div class="chips" style="margin-top:8px">
          <span class="chip">Dona Fausta no bus√£o ‚Üí melhorias n√£o pontuam.</span>
          <span class="chip">Apaixonados (2+ adjacentes) ‚Üí dobro da soma dos pontos base do grupo.</span>
        </div>
      </div>

      <div class="section" id="perrenguesSection" style="display:none;">
        <label>Perrengues (sem limite)</label>
        <div id="perrenguesButtons" class="bar" style="flex-wrap:wrap"></div>
        <div id="perrenguesInfo" class="drivers" style="margin-top:10px"></div>
      </div>

      <div class="section" id="rotasDiariasSection" style="display:none;">
        <label>Rotas Di√°rias (sem limite)</label>
        <div id="rotasDiariasButtons" class="bar" style="flex-wrap:wrap"></div>
        <div id="rotasDiariasInfo" class="drivers" style="margin-top:10px"></div>
      </div>

      <div class="section">
        <label>Cartas na m√£o (‚Äì1 cada)</label>
        <input id="handCount" type="number" min="0" step="1" value="0" />
      </div>
    </div>

    <div class="tabview" id="tab-seats">
      <div class="section">
        <div class="section-title">
          <span>Selecione o Assento</span>
          <button id="btnVisualHelp" class="btn ghost sm" title="Ajuda de adjac√™ncia">?</button>
        </div>
        <div class="section-sub">Clique no assento correspondente e escolha o personagem, o calculo √© automatizado ap√≥s escolher os assentos v√°lidos..</div>
        <div id="visualHelp" class="popover">
          <b>Adjac√™ncia:</b> esquerda/direita, cima/baixo, diagonais. Ex.: Assento 3 ‚Üí adjacentes: 2, 4, 8, 9, 10.
        </div>

        <div id="busVisual" class="bus-visual">
          <div class="driver"><div class="label">motorista</div></div>
          <div class="wheel w1"></div><div class="wheel w2"></div>
          <div class="seats" id="busVisualSeats"></div>
        </div>
      </div>

      <div class="grid" id="grid"></div>
      <div class="section"><div class="chips"><span class="chip">Adjac√™ncias v√°lidas ‚Äì ortogonais e diagonais</span></div></div>

      <div class="section">
        <label>A√ß√µes</label>
        <div class="bar">
          <button class="btn acc" id="btnClearSeats">Limpar assentos</button>
          <button class="btn ghost" id="btnNewRound">Nova pontua√ß√£o</button>
        </div>
      </div>

      <div class="section">
        <label>Salvar no Ranking</label>
        <div class="bar" style="margin-bottom:8px">
          <button class="btn accent" id="btnSaveScore">Salvar pontua√ß√£o</button>
          <button class="btn warn" id="btnResetRanking">Zerar ranking</button>
        </div>
        <div class="muted">Pontua√ß√µes salvas no seu navegador (localStorage).</div>
      </div>
    </div>

    <div class="tabview" id="tab-catalog">
      <div class="section">
        <div class="section-title"><span>Cat√°logo de Cartas</span></div>
        <div class="catalog">
          <div class="cat-controls">
            <input id="catalogSearch" placeholder="Busque por nome, tag ou palavra do efeito (ex.: Jovem, Tranquilo, Wi-Fi...)" />
            <button class="btn sm" id="clearCatalogSearch">Limpar</button>
            <div class="chips">
              <span class="chip">Dica: inclui Passageiros, Cobradores, Motoristas e Melhorias</span>
            </div>
          </div>
          <div id="catalogContent"></div>
        </div>
      </div>
    </div>

    <div class="tabview" id="tab-regrasfaq">
        <div class="section">
            <div class="section-title"><span>Regras & FAQ</span></div>
            <div class="tabs" style="display:flex;border-bottom:1px solid var(--line)">
                <div class="itab act" data-itab="regras" style="padding:10px 14px;cursor:pointer;color:#60a5fa;border-bottom:2px solid #60a5fa">Regras (online)</div>
                <div class="itab" data-itab="faq" style="padding:10px 14px;cursor:pointer;color:#cbd5e1;border-bottom:2px solid transparent">FAQ & Contato</div>
            </div>
        </div>
        <div class="rules-container">
            <h1>Regras do Bus√£o</h1>
            <p>Jogo de estrat√©gia e equil√≠brio para 2 a 6 jogadores</p>
            
            <div class="quick-summary">
                <p><b>Resumo R√°pido</b></p>
                <ul>
                    <li><b>Objetivo:</b> Somar pontos com passageiros + motorista + melhorias.</li>
                    <li><b>Fim do jogo:</b> Fim da Linha, Bus√£o lotado ou fim das cartas da rua.</li>
                    <li><b>Pontua√ß√£o:</b> Passageiros (efeitos), motorista (+1 por tags), melhorias (+1 por tags) e ‚Äì1 por carta na m√£o.</li>
                    <li><b>Apaixonados:</b> Podem repetir; se 2+ estiverem adjacentes formam um grupo que <b>dobra</b> a soma dos <b>pontos base</b> do grupo.</li>
                    <li><b>Grupo de Pagode:</b> Se reunir os 5 integrantes, ganha 50 pontos extras!</li>
                </ul>
            </div>
        
            <details class="rule-section" open>
                <summary><h2>Introdu√ß√£o</h2></summary>
                <div class="rule-content-body">
                    <p>Bus√£o √© um jogo de estrat√©gia e equilibro para 2 a 6 jogadores, onde voc√™ assume o volante de um √¥nibus lotado, com a miss√£o de controlar o embarque e desembarque de passageiros, garantindo conforto e evitando caos a bordo.</p>
                    <p>A cada rodada, voc√™ pode tentar resolver imprevistos para manter a harmonia entre os passageiros que s√£o t√£o diferentes entre si. Afinal, ningu√©m gosta de sentar-se ao lado de algu√©m indesejado.</p>
                    <p>Use suas cartas com intelig√™ncia, tome decis√µes r√°pidas e garanta o maior n√∫mero poss√≠vel de pontos com suas a√ß√µes. O Bus√£o est√° nas suas m√£os e a paz nessa viagem tamb√©m!</p>
                </div>
            </details>
            
            <details class="rule-section">
                <summary><h2>Expans√µes</h2></summary>
                <div class="rule-content-body">
                    <p><b>Estou no Bus√£o:</b> Passageiros especiais com habilidades √∫nicas.</p>
                    <p><b>Lendas Urbanas:</b> Personagens m√≠sticos com efeitos poderosos.</p>
                    <p><b>Grupo de Pagode:</b> 5 integrantes especiais - re√∫na todos para ganhar 50 pontos extras!</p>
                    <p><b>Rotas Di√°rias:</b> Cartas de b√¥nus que d√£o pontos extras por condi√ß√µes espec√≠ficas.</p>
                    <p><b>Perrengues:</b> Eventos desafiadores que afetam todos os jogadores.</p>
                </div>
            </details>
        </div>
        <div class="tabpan" id="itab-faq" style="display: none; padding: 12px;">
          <p><b>Perguntas frequentes</b></p>
          <details><summary>Como funciona a adjac√™ncia?</summary><div class="muted">Esquerda/direita + 3 da outra fileira (motorista n√£o conta).</div></details>
          <details><summary>‚ÄúEntre ele e o motorista‚Äù (Motolover)</summary><div class="muted">Conta todos nas colunas √† esquerda (duas fileiras).</div></details>
          <details><summary>Cartas na m√£o descontam?</summary><div class="muted">Sim, ‚Äì1 por carta restante (exceto se Isabel estiver no bus√£o).</div></details>
          <details><summary>Como funciona a expans√£o dos Apaixonados?</summary><div class="muted">Podem ser duplicados. Se 2+ estiverem adjacentes, dobram a soma dos pontos base do grupo.</div></details>
          <details><summary>Como funciona o Grupo de Pagode?</summary><div class="muted">Se reunir os 5 integrantes, ganha 50 pontos extras al√©m das pontua√ß√µes normais.</div></details>
          <p style="margin-top:10px">Contato: <a href="mailto:contato@busao.game">contato@busao.game</a></p>
        </div>
    </div>
  </div>

  <div class="panel">
    <header><h1>Resultado</h1><small id="playerTag"></small></header>
    <div class="section totals">
      <div class="total"><h3>Total</h3><div id="totalScore" class="v kpi neu">0</div></div>
      <div class="total"><h3>Quebra</h3>
        <div class="muted">Passageiros: <b id="sumPassengers">0</b></div>
        <div class="muted">Motorista: <b id="sumDriver">0</b></div>
        <div class="muted">Melhorias: <b id="sumImprov">0</b></div>
        <div class="muted">Perrengues: <b id="sumPerrengues">0</b></div>
        <div class="muted">Rotas Di√°rias: <b id="sumRotasDiarias">0</b></div>
        <div class="muted">M√£o: <b id="sumHand">0</b></div>
      </div>
    </div>
    <div class="section" style="padding-top:8px"><label>Explica√ß√£o por assento</label><div id="warnings" class="muted" style="margin-top:6px"></div><div id="explain" class="explain"></div></div>
    <div class="section">
      <label>Ranking</label>
      <div class="table-wrap">
        <table id="rankTable"><thead><tr><th>#</th><th>Jogador</th><th>Motorista</th><th>Melhorias</th><th class="right">Pontua√ß√£o</th></tr></thead><tbody></tbody></table>
      </div>
    </div>
    <div class="foot">Motorista e melhorias: +1 por ocorr√™ncia das subcategorias descritas. Cartas sem exig√™ncia de embarque sempre contam para eles.</div>
  </div>
</div>

<div id="pickerModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="pickerTitle">
  <div class="modal-card">
    <div class="modal-head">
      <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
        <strong id="pickerTitle">Escolher carta para o assento</strong>
        <span id="pickerSeatLabel" class="chip"></span>
      </div>
      <div class="bar">
        <button id="pickerClear" class="btn sm">Limpar assento</button>
        <button id="pickerClose" class="btn ghost sm">Fechar</button>
      </div>
    </div>
    <div class="modal-body">
      <div class="picker-filter">
        <input id="pickerSearch" placeholder="Buscar por nome/tag/efeito..." />
        <button class="pill act" data-tab="pass">Passageiros</button>
        <button class="pill" data-tab="cob">Cobradores</button>
        <button class="pill" data-tab="apx">Apaixonados</button>
        <button class="pill" data-tab="estou">Estou no Bus√£o</button>
        <button class="pill" data-tab="lendas">Lendas Urbanas</button>
        <button class="pill" data-tab="pagode">Grupo de Pagode</button>
      </div>
      <div id="pickerGrid" class="picker-grid"></div>
    </div>
  </div>
</div>

<script>
/* ============================
   MOTORISTAS & MELHORIAS
============================= */
const DRIVERS = [
  { id:"",        nome:"‚Äî selecione um motorista ‚Äî", bonus:[] },
  { id:"bigode",   nome:"Bigode",   bonus:["Jovem","Ca√≥tico","Barulhento"] },
  { id:"lucinha",  nome:"Lucinha",  bonus:["Adulto","Tranquilo","Silencioso"] },
  { id:"montanha", nome:"Montanha", bonus:["Idoso","Equilibrado","Comunicativo"] },
  { id:"paty",     nome:"Paty",     bonus:["Jovem","Tranquilo","Comunicativo"] },
  { id:"pedrinho", nome:"Pedrinho", bonus:["Adulto","Ca√≥tico","Silencioso"] },
  { id:"pereirao", nome:"Pereir√£o", bonus:["Idoso","Equilibrado","Barulhento"] },
];

const IMPROVEMENTS = [
  { id:"acess", nome:"Acessibilidade", bonus:["Idoso","Tranquilo"], reqTag:"Acessibilidade" },
  { id:"ar", nome:"Ar-condicionado", bonus:["Ca√≥tico","Silencioso"] },
  { id:"reclinaveis", nome:"Assentos Reclin√°veis", bonus:["Adulto","Barulhento"], reqTag:"Assentos Reclin√°veis" },
  { id:"banheiro", nome:"Banheiro", bonus:["Adulto","Silencioso"] },
  { id:"cortinas", nome:"Cortinas", bonus:["Idoso","Ca√≥tico"] },
  { id:"som", nome:"Sistema de Som", bonus:["Barulhento","Ca√≥tico"] },
  { id:"tv", nome:"TV de Bordo", bonus:["Equilibrado","Comunicativo"] },
  { id:"wifi", nome:"Wi-Fi e Tomadas", bonus:["Jovem","Comunicativo"], reqTag:"Wi-Fi e Tomadas" },
  { id:"seguranca", nome:"Sistema de Seguran√ßa", bonus:["Jovem","Tranquilo"], reqTag:"Sistema de Seguran√ßa" }
];

/* ============================
   PERRENGUES (EXPANS√ÉO)
============================= */
const PERRENGUES = [
  { 
    id: "transito", 
    nome: "Tr√¢nsito Parado", 
    efeito: "Durante este perrengue todos os jogadores possuem 4 pontos de a√ß√£o. Fim de jogo: Passageiros Barulhentos +1 ponto.", 
    bonus: ["Barulhento"],
    pontos: 1
  },
  { 
    id: "fiscalizacao", 
    nome: "Fiscaliza√ß√£o Surpresa", 
    efeito: "Ningu√©m pode realizar a a√ß√£o especial de Melhoria no Bus√£o enquanto este evento estiver ativo. Fim de jogo: Passageiros Tranquilos +2 pontos.", 
    bonus: ["Tranquilo"],
    pontos: 2
  },
  { 
    id: "flatulencia", 
    nome: "Flatul√™ncia no Bus√£o", 
    efeito: "Metade dos passageiros (arredondado para cima) desembarca; o jogador decide quem sai. Fim de jogo: Passageiros Ca√≥ticos +1 ponto.", 
    bonus: ["Ca√≥tico"],
    pontos: 1
  },
  { 
    id: "alagamento", 
    nome: "Ilhado no Bus√£o", 
    efeito: "Durante este Perrengue nenhum passageiro pode ser for√ßado a desembarcar. Fim de jogo: Passageiros Equilibrados +1 ponto.", 
    bonus: ["Equilibrado"],
    pontos: 1
  },
  { 
    id: "greve", 
    nome: "Greve dos Rodovi√°rios", 
    efeito: "Se este evento estiver ativo no fim do turno, os motoristas n√£o concedem pontos extras. Fim de jogo: Passageiros Jovens +1 ponto.", 
    bonus: ["Jovem"],
    pontos: 1
  },
  { 
    id: "obra", 
    nome: "Obra na Avenida Principal", 
    efeito: "Cada Jogador deve mover 2 passageiros do seu bus√£o para um bus√£o advers√°rio no sentido hor√°rio, e realizam seus efeitos de embarque caso tenha. Fim de jogo: Passageiros Adultos ‚Äì1 ponto.", 
    bonus: ["Adulto"],
    pontos: -1
  },
  { 
    id: "roubo", 
    nome: "Roubo de Celular", 
    efeito: "Todos os passageiros Jovens desembarcam, exceto 'O Trombadinha' (se estiver no bus√£o). Fim de jogo: Passageiros Silenciosos +1 ponto.", 
    bonus: ["Silencioso"],
    pontos: 1
  },
  { 
    id: "pneu", 
    nome: "Pneu Furado", 
    efeito: "Todos os jogadores t√™m apenas 2 pontos de a√ß√£o neste turno. Fim de jogo: Passageiros Idosos +2 pontos.", 
    bonus: ["Idoso"],
    pontos: 2
  },
  { 
    id: "troca", 
    nome: "Troca de Turno", 
    efeito: "Todos os motoristas s√£o substitu√≠dos por novos motoristas n√£o usados na prepara√ß√£o do jogo. Caso n√£o haja, os jogadores trocam de motoristas entre si no sentido hor√°rio. Fim de jogo: Passageiros Comunicativos +1 ponto.", 
    bonus: ["Comunicativo"],
    pontos: 1
  },
  { 
    id: "acidente", 
    nome: "Acidente de Tr√¢nsito", 
    efeito: "Durante este perrengue, os jogadores n√£o podem realizar a a√ß√£o de Pegar Passageiros. Fim de jogo: Escolha a categoria que seu motorista mais concede pontos e dobre estes pontos concedidos.", 
    bonus: [],
    pontos: 0 // Ser√° calculado dinamicamente
  }
];

/* ============================
   ROTAS DI√ÅRIAS (EXPANS√ÉO)
============================= */
const ROTAS_DIARIAS = [
  { 
    id: "parada_delegacia", 
    nome: "Parada na Delegacia", 
    efeito: "+5 pontos se houver 5 ou mais Ca√≥ticos no Bus√£o.",
    bonus: ["Ca√≥tico"],
    pontos: 5,
    condicao: (ctx) => ctx.countBus(c => !c.isCobrador && c.temper === "Ca√≥tico") >= 5
  },
  { 
    id: "parada_asilo", 
    nome: "Parada no Asilo", 
    efeito: "+5 pontos se houver 3 ou mais Idosos no Bus√£o.",
    bonus: ["Idoso"],
    pontos: 5,
    condicao: (ctx) => ctx.countBus(c => !c.isCobrador && c.faixa === "Idoso") >= 3
  },
  { 
    id: "via_shopping", 
    nome: "Via Shopping", 
    efeito: "+3 pontos se houver 2 ou mais Jovens no Bus√£o.",
    bonus: ["Jovem"],
    pontos: 3,
    condicao: (ctx) => ctx.countBus(c => !c.isCobrador && c.faixa === "Jovem") >= 2
  },
  { 
    id: "happy_hour", 
    nome: "Happy hour", 
    efeito: "+8 pontos se houver 5 ou mais Adultos no Bus√£o.",
    bonus: ["Adulto"],
    pontos: 8,
    condicao: (ctx) => ctx.countBus(c => !c.isCobrador && c.faixa === "Adulto") >= 5
  },
  { 
    id: "rota_comum", 
    nome: "Rota Comum", 
    efeito: "+10 pontos se houver 5 ou mais equilibrados adjacentes.",
    bonus: ["Equilibrado"],
    pontos: 10,
    condicao: (ctx) => {
      let maxAdj = 0;
      for(let r=0;r<ROWS;r++) {
        for(let c=0;c<COLS;c++) {
          const card = ctx.grid[r][c].card;
          if(card && !card.isCobrador && card.temper === "Equilibrado") {
            const visited = new Set();
            const queue = [{row:r, col:c}];
            visited.add(`${r},${c}`);
            let count = 0;
            while(queue.length) {
              const cur = queue.shift();
              count++;
              for(const nb of ctx.neighbors(cur)) {
                const key = `${nb.row},${nb.col}`;
                if(!visited.has(key)) {
                  const nbCard = ctx.grid[nb.row][nb.col].card;
                  if(nbCard && !nbCard.isCobrador && nbCard.temper === "Equilibrado") {
                    visited.add(key);
                    queue.push(nb);
                  }
                }
              }
            }
            if(count > maxAdj) maxAdj = count;
          }
        }
      }
      return maxAdj >= 5;
    }
  },
  { 
    id: "via_paraiso", 
    nome: "Via Para√≠so", 
    efeito: "+8 pontos se houver 5 ou mais Tranquilos no Bus√£o.",
    bonus: ["Tranquilo"],
    pontos: 8,
    condicao: (ctx) => ctx.countBus(c => !c.isCobrador && c.temper === "Tranquilo") >= 5
  },
  { 
    id: "passar_cinema", 
    nome: "Passar do Cinema", 
    efeito: "+10 pontos se houver 5 ou mais Silenciosos adjacentes.",
    bonus: ["Silencioso"],
    pontos: 10,
    condicao: (ctx) => {
      let maxAdj = 0;
      for(let r=0;r<ROWS;r++) {
        for(let c=0;c<COLS;c++) {
          const card = ctx.grid[r][c].card;
          if(card && !card.isCobrador && card.comp === "Silencioso") {
            const visited = new Set();
            const queue = [{row:r, col:c}];
            visited.add(`${r},${c}`);
            let count = 0;
            while(queue.length) {
              const cur = queue.shift();
              count++;
              for(const nb of ctx.neighbors(cur)) {
                const key = `${nb.row},${nb.col}`;
                if(!visited.has(key)) {
                  const nbCard = ctx.grid[nb.row][nb.col].card;
                  if(nbCard && !nbCard.isCobrador && nbCard.comp === "Silencioso") {
                    visited.add(key);
                    queue.push(nb);
                  }
                }
              }
            }
            if(count > maxAdj) maxAdj = count;
          }
        }
      }
      return maxAdj >= 5;
    }
  },
  { 
    id: "parar_feira", 
    nome: "Parar na feira livre", 
    efeito: "+4 pontos se houver 3 ou mais Comunicativos no Bus√£o.",
    bonus: ["Comunicativo"],
    pontos: 4,
    condicao: (ctx) => ctx.countBus(c => !c.isCobrador && c.comp === "Comunicativo") >= 3
  },
  { 
    id: "show_rock", 
    nome: "Show de Rock no Centro", 
    efeito: "+4 pontos se houver 4 ou mais Barulhentos no Bus√£o.",
    bonus: ["Barulhento"],
    pontos: 4,
    condicao: (ctx) => ctx.countBus(c => !c.isCobrador && c.comp === "Barulhento") >= 4
  },
  { 
    id: "linha_fantasma", 
    nome: "Linha Fantasma", 
    efeito: "+8 pontos pela maior quantidade de espa√ßos vazios no Bus√£o no fim do jogo.",
    bonus: [],
    pontos: 8,
    condicao: (ctx) => {
      let vazios = 0;
      for(let r=0;r<ROWS;r++) for(let c=0;c<COLS;c++) if(!ctx.grid[r][c].card) vazios++;
      return vazios > 0;
    }
  }
];

/* ============================
   FUN√á√ÉO AUXILIAR reqImprovement (CR√çTICA)
============================= */
function reqImprovement(ctx, name) {
  return { ok: ctx.hasImprovement(name), msg: `Requer a melhoria "${name}".` };
}

/* ============================
   CARTAS (passageiros base)
============================= */
function P(obj){ return Object.assign({base:0,faixa:"Adulto",temper:"Equilibrado",comp:"Comunicativo",
  impacto:"final", ability:null, penalty:null, require:null, scoreReq:null, note:null, text:null, isCobrador:false, allowDup:false, isApaixonado:false}, obj); }

const CARD_DB = [
  // Passageiros com Habilidades
  P({id:"caio",nome:"Caio (O Estudante)",base:4,faixa:"Jovem",temper:"Ca√≥tico",comp:"Silencioso",
     text:"+1 Ponto para cada Silencioso adjacente.",
     ability:(p,ctx,log)=>{ const n=ctx.countAdj(p, c=>c.comp==="Silencioso"); if(n) log(`+${n} por Silencioso adj.`); return n; }
  }),
  P({id:"leandro",nome:"Leandro (O Dorminhoco)",base:3,faixa:"Adulto",temper:"Equilibrado",comp:"Silencioso",
     text:"+1 Ponto para cada Silencioso no bus√£o.",
     ability:(p,ctx,log)=>{ const n=ctx.countBus(c=>!c.isCobrador && c.comp==="Silencioso"); if(n) log(`+${n} por Silencioso no bus√£o`); return n; }
  }),
  P({id:"sol",nome:"Sol (Good Vibes)",base:2,faixa:"Jovem",temper:"Tranquilo",comp:"Silencioso",
     text:"+1 Ponto por cada Equilibrado e cada Comunicativo no Bus√£o.",
     ability:(p,ctx,log)=>{ const e=ctx.countBus(c=>!c.isCobrador && c.temper==="Equilibrado"); const cm=ctx.countBus(c=>!c.isCobrador && c.comp==="Comunicativo");
       let s=0; if(e){log(`+${e} por Equilibrado no bus√£o`); s+=e;} if(cm){log(`+${cm} por Comunicativo no bus√£o`); s+=cm;} return s; }
  }),
  P({id:"rato",nome:"Rato (O Malandro)",base:1,faixa:"Jovem",temper:"Ca√≥tico",comp:"Barulhento",
     text:"+2 pontos por cada Idoso no bus√£o.",
     ability:(p,ctx,log)=>{ const n=ctx.countBus(c=>!c.isCobrador && c.faixa==="Idoso"); if(n){log(`+${2*n} (+2 por ${n} Idoso no bus√£o)`);} return 2*n; }
  }),
  P({id:"raul",nome:"Raul (O Pancada)",base:3,faixa:"Idoso",temper:"Equilibrado",comp:"Barulhento",
     text:"+1 Ponto por cada Jovem e cada Comunicativo Adjacente.",
     ability:(p,ctx,log)=>{ const j=ctx.countAdj(p,c=>c.faixa==="Jovem"); const co=ctx.countAdj(p,c=>c.comp==="Comunicativo");
       let s=0; if(j){log(`+${j} por Jovem adj.`); s+=j;} if(co){log(`+${co} por Comunicativo adj.`); s+=co;} return s; }
  }),
  P({id:"dona_cida",nome:"Dona Cida (A Tagarela)",base:4,faixa:"Idoso",temper:"Ca√≥tico",comp:"Barulhento",impacto:"durante-final",
     text:"Pode fazer um Silencioso desembarcar. +1 Ponto por cada Barulhento adjacente.",
     ability:(p,ctx,log)=>{ const n=ctx.countAdj(p,c=>c.comp==="Barulhento"); if(n){log(`+${n} por Barulhento adj.`);} return n; },
     note:"Pode fazer um Silencioso desembarcar."
  }),
  P({id:"cleber",nome:"Cl√©ber (O Vendedor)",base:3,faixa:"Adulto",temper:"Ca√≥tico",comp:"Barulhento",impacto:"durante",
     text:"Pode fazer um adulto ou um jovem desembarcar.",
     note:"Pode fazer um adulto ou um jovem desembarcar."
  }),
  P({id:"sophia",nome:"Sophia (A Blogueira)",base:2,faixa:"Jovem",temper:"Ca√≥tico",comp:"Barulhento",
     text:"Se houver a melhoria Wi-Fi e Tomadas, +2 pontos por cada Jovem no Bus√£o.",
     ability:(p,ctx,log)=>{ if(!ctx.hasImprovement("Wi-Fi e Tomadas")) return 0; const n=ctx.countBus(c=>!c.isCobrador && c.faixa==="Jovem");
       if(n){log(`+${2*n} (Wi-Fi ativo: +2 por ${n} Jovem no bus√£o)`);} return 2*n; }
  }),
  P({id:"seu_horacio",nome:"Seu Hor√°cio (O Antissocial)",base:3,faixa:"Idoso",temper:"Equilibrado",comp:"Silencioso",
     text:"+3 Pontos para cada espa√ßo vazio adjacente.",
     ability:(p,ctx,log)=>{ const e=ctx.countAdjEmpty(p); if(e){log(`+${3*e} (+3 por ${e} vazio adj.)`);} return 3*e; }
  }),
  P({id:"sheila",nome:"Sheila (A Barraqueira)",base:4,faixa:"Jovem",temper:"Ca√≥tico",comp:"Barulhento",impacto:"durante",
     text:"N√£o pode ser for√ßada a desembarcar. Ao embarcar, outros 2 passageiros desembarcam.",
     note:"N√£o pode ser for√ßada a desembarcar. Ao embarcar, outros 2 passageiros desembarcam."
  }),
  P({id:"feitosa",nome:"Feitosa (O Policial)",base:2,faixa:"Adulto",temper:"Ca√≥tico",comp:"Comunicativo",impacto:"durante-final",
     text:"+1 ponto por cada Tranquilo no Bus√£o. For√ßa 'O Trombadinha' a desembarcar e impede seu embarque.",
     ability:(p,ctx,log)=>{ const n=ctx.countBus(c=>!c.isCobrador && c.temper==="Tranquilo"); if(n) log(`+${n} por Tranquilo no bus√£o`); return n; },
     note:"For√ßa 'Fa√≠sca (O Trombadinha)' a desembarcar e impede seu embarque."
  }),

  // Passageiros com Penalidades
  P({id:"seu_amadeu",nome:"Seu Amadeu (O Irritado)",base:5,faixa:"Idoso",temper:"Ca√≥tico",comp:"Barulhento",impacto:"durante",
     text:"Faz todos os Jovens adjacentes desembarcarem.",
     note:"Faz todos os Jovens adjacentes desembarcarem."
  }),
  P({id:"wesley",nome:"Wesley (O DJ do bus√£o)",base:3,faixa:"Jovem",temper:"Ca√≥tico",comp:"Barulhento",impacto:"durante",
     text:"Faz todos os Silenciosos adjacentes desembarcarem.",
     note:"Faz todos os Silenciosos adjacentes desembarcarem."
  }),
  P({id:"celio",nome:"C√©lio (O Claustrof√≥bico)",base:3,faixa:"Jovem",temper:"Ca√≥tico",comp:"Silencioso",
     text:"N√£o embarca se n√£o houver pelo menos 1 espa√ßo vazio adjacente. -1 ponto por cada passageiro adjacente.",
     penalty:(p,ctx,log)=>{ const n=ctx.countAdj(p,()=>true); if(n){log(`-${n} ( -1 por adj.)`);} 
       const e=ctx.countAdjEmpty(p); if(e===0) ctx.warn("C√©lio: precisa de ao menos 1 espa√ßo vazio adjacente durante o jogo (condi√ß√£o de embarque).");
       return -n; }
  }),
  P({id:"marcia_enzo",nome:"M√°rcia e Enzo (M√£e e Pestinha)",base:2,faixa:"Adulto",temper:"Equilibrado",comp:"Barulhento",
     text:"-2 Pontos para cada Silencioso no Bus√£o.",
     penalty:(p,ctx,log)=>{ const n=ctx.countBus(c=>!c.isCobrador && c.comp==="Silencioso"); if(n){log(`-${2*n} ( -2 por ${n} Silencioso no bus√£o )`);} return -2*n; }
  }),
  P({id:"motolover",nome:"Luiz (Motolover)",base:3,faixa:"Adulto",temper:"Equilibrado",comp:"Silencioso",
     text:"-2 Pontos por cada passageiro no Bus√£o que estiver sentado entre ele e o motorista.",
     penalty:(p,ctx,log)=>{ 
       // Contar todos os passageiros em ambas as fileiras nas colunas √† esquerda
       let n=0;
       for(let c=0; c<p.col; c++) {
         // Fileira 0 (cima)
         const card0 = ctx.grid[0][c].card;
         if(card0 && ctx.isActiveAt({row:0, col:c})) n++;
         // Fileira 1 (baixo)
         const card1 = ctx.grid[1][c].card;
         if(card1 && ctx.isActiveAt({row:1, col:c})) n++;
       }
       if(n){log(`-${2*n} ( -2 por ${n} entre ele e o motorista )`);}
       return -2*n;
     }
  }),
  P({id:"fabao",nome:"Fab√£o (O Grand√£o)",base:1,faixa:"Adulto",temper:"Ca√≥tico",comp:"Silencioso",impacto:"durante",
     text:"Ocupa 1 espa√ßo com passageiros e faz todos neste local desembarcarem.",
     note:"Ocupa 1 espa√ßo com passageiros e faz todos neste local desembarcarem."
  }),
  P({id:"waldisnei",nome:"Waldisnei (O Cheiroso)",base:0,faixa:"Jovem",temper:"Ca√≥tico",comp:"Comunicativo",impacto:"durante",
     text:"Ao embarcar, faz 2 passageiros adjacentes desembarcarem. -1 Ponto por cada passageiro adjacente.",
     penalty:(p,ctx,log)=>{ const n=ctx.countAdj(p,()=>true); if(n){log(`-${n} ( -1 por adj.)`);} return -n; },
     note:"Ao embarcar, faz 2 passageiros adjacentes desembarcarem."
  }),
  P({id:"claudio",nome:"Cl√°udio (O Pastor)",base:2,faixa:"Adulto",temper:"Ca√≥tico",comp:"Barulhento",impacto:"durante",
     text:"Ao embarcar faz todos os Jovens adjacentes desembarcarem. -1 ponto para cada Silencioso no Bus√£o.",
     penalty:(p,ctx,log)=>{ const n=ctx.countBus(c=>!c.isCobrador && c.comp==="Silencioso"); if(n){log(`-${n} ( -1 por ${n} Silencioso no bus√£o )`);} return -n; },
     note:"Ao embarcar faz todos os Jovens adjacentes desembarcarem."
  }),
  P({id:"roberto",nome:"Roberto (O Bonzinho)",base:6,faixa:"Adulto",temper:"Equilibrado",comp:"Comunicativo",impacto:"durante",
     text:"Se, depois dele, um Idoso ou 'A Gestante' embarcar, ele desembarca para ceder o seu lugar.",
     note:"Se, depois dele, um Idoso ou 'A Gestante' embarcar, ele desembarca para ceder o seu lugar."
  }),
  P({id:"charles",nome:"Charles (O Maromba)",base:4,faixa:"Adulto",temper:"Equilibrado",comp:"Barulhento",
     text:"-1 ponto por cada passageiro adjacente. -3 Pontos se 'O Grand√£o' estiver no Bus√£o.",
     penalty:(p,ctx,log)=>{ const adj=ctx.countAdj(p,()=>true); let s=-adj; if(ctx.existsId("fabao")){ s-=3; log("-3 adicionais: Grand√£o presente"); }
       if(adj) log(`-${adj} ( -1 por adj.)`); return s; }
  }),
  P({id:"yasmin",nome:"Yasmin (A Louca por Gatos)",base:2,faixa:"Adulto",temper:"Tranquilo",comp:"Comunicativo",
     text:"-1 ponto por cada passageiro Adulto no Bus√£o, -5 pontos se 'O Caramelo' estiver no Bus√£o.",
     penalty:(p,ctx,log)=>{ 
       const adultos = ctx.countBus(c=>!c.isCobrador && c.faixa==="Adulto");
       let s = -adultos;
       if(ctx.existsId("costelinha")) { s -= 5; log("-5 adicionais: Caramelo presente"); }
       if(adultos) log(`-${adultos} ( -1 por ${adultos} Adulto no bus√£o )`);
       return s;
     }
  }),

  // Passageiros com Exig√™ncias
  P({id:"ana_gestante",nome:"Ana (A Gestante)",base:5,faixa:"Adulto",temper:"Tranquilo",comp:"Comunicativo",
     text:"S√≥ embarca se o Bus√£o estiver equipado com a melhoria Assentos Reclin√°veis.",
     require:(ctx)=> reqImprovement(ctx,"Assentos Reclin√°veis")
  }),
  P({id:"joao_cadeirante",nome:"Jo√£o (O Cadeirante)",base:6,faixa:"Jovem",temper:"Equilibrado",comp:"Silencioso",
     text:"S√≥ embarca se o Bus√£o estiver equipado com a melhoria Acessibilidade.",
     require:(ctx)=> reqImprovement(ctx,"Acessibilidade")
  }),
  P({id:"peter",nome:"Peter (O Playboy)",base:7,faixa:"Jovem",temper:"Equilibrado",comp:"Barulhento",
     text:"S√≥ embarca se o Bus√£o estiver equipado com todas as 3 melhorias poss√≠veis.",
     require:(ctx)=> ({ok: ctx.improvements.length===3, msg:"Precisa das 3 melhorias ativas."})
  }),
  P({id:"mari",nome:"Mari (A Conectada)",base:4,faixa:"Jovem",temper:"Tranquilo",comp:"Silencioso",
     text:"S√≥ embarca se o Bus√£o estiver equipado com a melhoria Wi-Fi e Tomadas.",
     require:(ctx)=> reqImprovement(ctx,"Wi-Fi e Tomadas")
  }),
  P({id:"wilson",nome:"Wilson (O Pai de Planta)",base:5,faixa:"Adulto",temper:"Equilibrado",comp:"Comunicativo",
     text:"S√≥ embarca se puder ocupar os 2 Assentos de uma mesma coluna. +1 Ponto para cada Idoso adjacente.",
     ability:(p,ctx,log)=>{ const n=ctx.countAdj(p,c=>c.faixa==="Idoso"); if(n){log(`+${n} por Idoso adj.`);} return n; },
     require:(ctx,p)=> {
       const other = p.row===0 ? ctx.getPos(1,p.col) : ctx.getPos(0,p.col);
       const ok = !other.card;
       return {ok, msg:"Wilson ocupa os 2 lugares (deixe vazio o par da coluna)."};
     }
  }),
  P({id:"dona_mirtes",nome:"Dona Mirtes (A Fofoqueira)",base:5,faixa:"Adulto",temper:"Tranquilo",comp:"Comunicativo",
     text:"S√≥ pontua se estiver adjacente a pelo menos um Comunicativo.",
     scoreReq:(ctx,p)=> ({ok: ctx.countAdj(p,c=>c.comp==="Comunicativo")>0, msg:"Precisa estar adjacente a pelo menos 1 Comunicativo para pontuar."})
  }),
  P({id:"misterioso",nome:"O Misterioso",base:4,faixa:"Adulto",temper:"Tranquilo",comp:"Silencioso",
     text:"S√≥ embarca se puder se sentar no fundo do Bus√£o (coluna 6).",
     require:(ctx,p)=> ({ok: p.col===5, msg:"S√¥ embarca no fundo do bus√£o (coluna 6)."})
  }),

  // Passageiros Especiais
  P({id:"jorge",nome:"Jorge (O Perdido)",base:4,faixa:"Adulto",temper:"Ca√≥tico",comp:"Barulhento",impacto:"durante",
     text:"Embarque imediato sem custo. Troca de Bus√£o no sentido hor√°rio ao final de cada rodada.",
     note:"Embarque imediato sem custo. Troca de Bus√£o no sentido hor√°rio ao final de cada rodada."
  }),
  P({id:"dabs",nome:"Dabs (A Board Gamer)",base:6,faixa:"Adulto",temper:"Tranquilo",comp:"Comunicativo",impacto:"durante",
     text:"Ao embarcar, pode fazer at√© dois passageiros com Penalidade desembarcarem.",
     note:"Ao embarcar, pode fazer at√© dois passageiros com Penalidade desembarcarem."
  }),
  P({id:"dona_fausta",nome:"Dona Fausta (A Desconfiada)",base:1,faixa:"Idoso",temper:"Ca√≥tico",comp:"Silencioso",
     text:"Se estiver no Bus√£o no fim da partida, as melhorias do bus√£o n√£o d√£o pontos extras.",
     note:"Se estiver no Bus√£o no fim da partida, as melhorias do bus√£o n√£o d√£o pontos extras."
  }),
  P({id:"costelinha",nome:"Costelinha (O Caramelo)",base:1,faixa:"?",temper:"?",comp:"?",
     text:"+1 ponto para cada passageiro no Bus√£o.",
     ability:(p,ctx,log)=>{ const n=ctx.countBus(c=>!c.isCobrador); if(n){log(`+${n} por ${n} passageiro(s) no bus√£o`);} return n; }
  }),
  P({id:"vovo_michel",nome:"Vov√≥ Michel (O Guia do Bus√£o)",base:0,faixa:"Idoso",temper:"Equilibrado",comp:"Barulhento",
     text:"Dobra os pontos concedidos pelo motorista.",
     note:"Dobra os pontos concedidos pelo motorista.",
  }),
  P({id:"alison",nome:"Alison (O Mago de Araque)",base:3,faixa:"Adulto",temper:"Tranquilo",comp:"Comunicativo",impacto:"durante",
     text:"Ao embarcar faz um passageiro √† sua escolha em cada Bus√£o advers√°rio desembarcar.",
     note:"Ao embarcar faz um passageiro √† sua escolha em cada Bus√£o advers√°rio desembarcar."
  }),
  P({id:"soraya",nome:"Soraya (A Cigana)",base:4,faixa:"Idoso",temper:"Ca√≥tico",comp:"Comunicativo",impacto:"durante-final",
     text:"Olhe a m√£o de um jogador e pegue uma carta para voc√™. +1 ponto para Adultos adjacentes.",
     ability:(p,ctx,log)=>{ const n=ctx.countAdj(p, c=>c.faixa==="Adulto"); if(n) log(`+${n} por Adulto adj.`); return n; },
     note:"Efeito de jogo: Olhe a m√£o de um jogador e pegue uma carta para voc√™."
  }),
  P({id:"bianca_bombom",nome:"Bianca Bombom (A Drag Queen)",base:5,faixa:"Adulto",temper:"Equilibrado",comp:"Barulhento",impacto:"durante",
     text:"Ao embarcar, pode trocar at√© 3 passageiros de lugar dentro do Bus√£o.",
     note:"Ao embarcar, pode trocar at√© 3 passageiros de lugar dentro do Bus√£o."
  }),
  P({id:"faisca",nome:"Fa√≠sca (O Trombadinha)",base:1,faixa:"Jovem",temper:"Ca√≥tico",comp:"Silencioso",impacto:"durante-final",
     text:"Puxe 1 carta da m√£o de cada jogador advers√°rio para voc√™.",
     note:"Efeito de jogo: Puxe 1 carta da m√£o de cada jogador advers√°rio para voc√™.",
     require:(ctx)=> ({ok: !ctx.existsId("feitosa"), msg:"N√£o embarca se Feitosa (O Policial) estiver no bus√£o."})
  }),
  P({id:"marcelo",nome:"Marcelo (O Papai Noel de Shopping)",base:1,faixa:"Idoso",temper:"Equilibrado",comp:"Silencioso",impacto:"durante",
     text:"Ganhe 1 carta da m√£o de cada jogador. Em seguida d√™ uma carta da sua m√£o a um jogador √† sua escolha.",
     note:"Efeito de jogo: Ganhe 1 carta da m√£o de cada jogador. Em seguida d√™ uma carta da sua m√£o a um jogador √† sua escolha."
  }),
  P({id:"douglas",nome:"Douglas (O Rapper do Bus√£o)",base:3,faixa:"Adulto",temper:"Equilibrado",comp:"Barulhento",impacto:"durante",
     text:"Anuncie o nome de um passageiro ou cobrador. Procure-o no terminal e embarque o sem custo.",
     note:"Efeito de jogo: Anuncie o nome de um passageiro ou cobrador. Procure-o no terminal e embarque o sem custo."
  }),
  P({id:"serjao",nome:"Serj√£o (O Mec√¢nico)",base:3,faixa:"Adulto",temper:"Tranquilo",comp:"Silencioso",impacto:"durante",
     text:"Ao embarcar, pode realizar uma Melhoria do Bus√£o sem custo.",
     note:"Ao embarcar, pode realizar uma Melhoria do Bus√£o sem custo."
  }),
  P({id:"dona_neuza",nome:"Dona Neuza (A Sacoleira)",base:4,faixa:"Adulto",temper:"Ca√≥tico",comp:"Comunicativo",impacto:"durante",
     text:"Enquanto ela estiver embarcada, quem controla o Bus√£o recebe +1 ponto de a√ß√£o.",
     note:"Enquanto ela estiver embarcada, quem controla o Bus√£o recebe +1 ponto de a√ß√£o."
  })
];

/* ============================
   EXPANS√ÉO ‚Äì COBRADORES (m√°x. 1)
============================= */
const COBRADORES = [
  P({id:"cob_marlene",nome:"Marlene (O Anjo da Terceira idade) [Cobrador]",isCobrador:true,base:0,
     text:"+2 pontos para cada Idoso",
     ability:(p,ctx,log)=>{const n=ctx.countBus(c=>!c.isCobrador && c.faixa==="Idoso"); if(n) log(`+${2*n} (+2 por ${n} Idoso)`); return 2*n;}
  }),
  P({id:"cob_ze",nome:"Z√© (O Tioz√£o) [Cobrador]",isCobrador:true,base:0,
     text:"+2 pontos para cada Adulto",
     ability:(p,ctx,log)=>{const n=ctx.countBus(c=>!c.isCobrador && c.faixa==="Adulto"); if(n) log(`+${2*n} (+2 por ${n} Adulto)`); return 2*n;}
  }),
  P({id:"cob_brenda",nome:"Brenda (A Jovenzona) [Cobrador]",isCobrador:true,base:0,
     text:"+2 pontos para cada Jovem",
     ability:(p,ctx,log)=>{const n=ctx.countBus(c=>!c.isCobrador && c.faixa==="Jovem"); if(n) log(`+${2*n} (+2 por ${n} Jovem)`); return 2*n;}
  }),
  P({id:"cob_angelina",nome:"Angelina (A tranquilidade em pessoa) [Cobrador]",isCobrador:true,base:0,
     text:"+2 pontos para cada Tranquilo",
     ability:(p,ctx,log)=>{const n=ctx.countBus(c=>!c.isCobrador && c.temper==="Tranquilo"); if(n) log(`+${2*n} (+2 por ${n} Tranquilo)`); return 2*n;}
  }),
  P({id:"cob_saulo",nome:"Saulo (O Indiferente) [Cobrador]",isCobrador:true,base:0,
     text:"+2 pontos para cada Equilibrado",
     ability:(p,ctx,log)=>{const n=ctx.countBus(c=>!c.isCobrador && c.temper==="Equilibrado"); if(n) log(`+${2*n} (+2 por ${n} Equilibrado)`); return 2*n;}
  }),
  P({id:"cob_leozinho",nome:"L√©ozinho (O Causador) [Cobrador]",isCobrador:true,base:0,
     text:"+2 pontos para cada Ca√≥tico",
     ability:(p,ctx,log)=>{const n=ctx.countBus(c=>!c.isCobrador && c.temper==="Ca√≥tico"); if(n) log(`+${2*n} (+2 por ${n} Ca√≥tico)`); return 2*n;}
  }),
  P({id:"cob_padilha",nome:"Padilha (O Cansado) [Cobrador]",isCobrador:true,base:0,
     text:"+2 pontos para cada Silencioso",
     ability:(p,ctx,log)=>{const n=ctx.countBus(c=>!c.isCobrador && c.comp==="Silencioso"); if(n) log(`+${2*n} (+2 por ${n} Silencioso)`); return 2*n;}
  }),
  P({id:"cob_camila",nome:"Camila (A Conversadeira) [Cobrador]",isCobrador:true,base:0,
     text:"+2 pontos para cada Comunicativo",
     ability:(p,ctx,log)=>{const n=ctx.countBus(c=>!c.isCobrador && c.comp==="Comunicativo"); if(n) log(`+${2*n} (+2 por ${n} Comunicativo)`); return 2*n;}
  }),
  P({id:"cob_gilmar",nome:"Gilmar (O Escandaloso) [Cobrador]",isCobrador:true,base:0,
     text:"+2 pontos para cada Barulhento",
     ability:(p,ctx,log)=>{const n=ctx.countBus(c=>!c.isCobrador && c.comp==="Barulhento"); if(n) log(`+${2*n} (+2 por ${n} Barulhento)`); return 2*n;}
  }),
];

/* ============================
   EXPANS√ÉO ‚Äì OS APAIXONADOS (duplic√°veis)
============================= */
const APAIXONADOS = [
  P({id:"apa_paulo",nome:"Paulo (O Apaixonado)", base:3, faixa:"Jovem", temper:"Equilibrado", comp:"Comunicativo",
     text:"Pode atrair um outro Apaixonado(a) que estiver vis√≠vel no Ponto de √înibus ou no Terminal para dentro do seu Bus√£o.", allowDup:true, isApaixonado:true }),
  P({id:"apa_silvinha",nome:"Silvinha (A Apaixonada)", base:2, faixa:"Jovem", temper:"Tranquilo", comp:"Silencioso",
     text:"Pode procurar por um Apaixonado(a) dentro do Terminal e embarcar imediatamente sem custo ao seu lado.", allowDup:true, isApaixonado:true }),
  P({id:"apa_igor",nome:"Igor (O Apaixonado)", base:1, faixa:"Jovem", temper:"Ca√≥tico", comp:"Silencioso",
     text:"Pode atrair um(a) outro(a) apaixonado(a) de dentro de um Bus√£o advers√°rio para a sua m√£o.", allowDup:true, isApaixonado:true }),
  P({id:"apa_jessica",nome:"J√©ssica (A Apaixonada)", base:4, faixa:"Jovem", temper:"Equilibrado", comp:"Barulhento",
     text:"S√≥ pontua se estiver com outro(a) apaixonado(a) no Bus√£o.", allowDup:true, isApaixonado:true,
     scoreReq:(ctx,p)=> ({ok: ctx.countBus(c=>c.isApaixonado)>1, msg:"Precisa estar com outro apaixonado no bus√£o para pontuar."})
  }),
];

/* ============================
   EXPANS√ÉO ‚Äì ESTOU NO BUSAO
============================= */
const ESTOU_NO_BUSAO = [
  P({id:"gleidson",nome:"Gleidson (O Sensitivo)",base:3,faixa:"Adulto",temper:"Tranquilo",comp:"Silencioso",
     note:"Enquanto estiver embarcado, voc√™ pode olhar as 3 primeiras cartas da Rua uma vez por turno, sem custo."
  }),
  P({id:"marcos",nome:"Marcos (O Desligado)",base:5,faixa:"Adulto",temper:"Equilibrado",comp:"Silencioso",
     note:"Se algum passageiro for for√ßado a desembarcar, ele tamb√©m desembarca."
  }),
  P({id:"ursinha",nome:"Ursinha (A Furiosa)",base:0,faixa:"?",temper:"?",comp:"?",
     penalty:(p,ctx,log)=>{ const n=ctx.countBus(c=>!c.isCobrador); if(n){log(`-${n} ( -1 por ${n} passageiro(s) no bus√£o )`);} return -n; },
     text:"-1 ponto por cada passageiro no Bus√£o."
  }),
  P({id:"santiago",nome:"Santiago (O Par√ßa do Bus√£o)",base:2,faixa:"Adulto",temper:"Equilibrado",comp:"Comunicativo",
     text:"+5 pontos se, ao final do jogo, o Bus√£o estiver completo, com todos os assentos ocupados.",
     ability:(p,ctx,log)=>{ 
       let ocupados = 0;
       for(let r=0;r<ROWS;r++) for(let c=0;c<COLS;c++) if(ctx.grid[r][c].card) ocupados++;
       if(ocupados === 12) { log("+5 (Bus√£o completo)"); return 5; }
       return 0;
     }
  }),
  P({id:"sao_dadinho",nome:"S√£o Dadinho (O Mascote de Loja)",base:4,faixa:"Jovem",temper:"Equilibrado",comp:"Barulhento",
     note:"Ao embarcar, role um dado: se tirar 6, jogue outro turno com 3 pontos de a√ß√£o, caso contr√°rio, nada acontece."
  }),
  P({id:"bia_cosmic",nome:"Bia Cosmic (A Sonhadora)",base:4,faixa:"Idoso",temper:"Ca√≥tico",comp:"Comunicativo",
     note:"Se 'A Board Gamer' estiver no Bus√£o, ela embarca sem custo e vice-versa."
  }),
  P({id:"sabrina",nome:"Sabrina (A Guerreira)",base:2,faixa:"Adulto",temper:"Equilibrado",comp:"Comunicativo",
     note:"Protege a coluna em que est√°. Nenhum passageiro nela pode ser for√ßado a desembarcar."
  }),
  P({id:"adriana",nome:"Adriana (A Professora)",base:3,faixa:"Adulto",temper:"Equilibrado",comp:"Comunicativo",
     note:"Ao embarcar, pode pegar todos os Jovens do Ponto de √înibus e do topo do Terminal para sua m√£o sem custo."
  }),
  P({id:"elblond",nome:"Elblond (O Cosplayer)",base:0,faixa:"Adulto",temper:"Ca√≥tico",comp:"Barulhento",
     note:"Pode ser descartado no Terminal para dar lugar a outro passageiro sem custo de embarque."
  }),
  P({id:"lais_fofinha",nome:"Lais (A Fofinha)",base:1,faixa:"Jovem",temper:"Tranquilo",comp:"Comunicativo",
     text:"Se houver a melhoria Ar-condicionado, +1 ponto para cada passageiro adjacente.",
     ability:(p,ctx,log)=>{ if(!ctx.hasImprovement("Ar-condicionado")) return 0; const n=ctx.countAdj(p,()=>true); if(n){log(`+${n} (Ar-condicionado ativo: +1 por ${n} adj.)`);} return n; }
  }),
  P({id:"brenda_ti",nome:"Brenda (A mo√ßa do TI)",base:2,faixa:"Adulto",temper:"Equilibrado",comp:"Silencioso",
     note:"Pode embarcar 1 passageiro sem custo em qualquer Bus√£o."
  }),
  P({id:"alessa",nome:"Alessa (A Multitarefas)",base:1,faixa:"Adulto",temper:"Ca√≥tico",comp:"Comunicativo",
     note:"Ao embarcar, jogue um novo turno completo com 3 Pontos de A√ß√£o."
  }),
  P({id:"lais_cansada",nome:"Lais (A Cansada)",base:3,faixa:"Adulto",temper:"Tranquilo",comp:"Silencioso",
     note:"Enquanto ela estiver embarcada, o jogador que controla o Bus√£o em que ela est√° tem -1 Ponto de A√ß√£o."
  }),
  P({id:"josias",nome:"Josias (O Jogador de RPG)",base:2,faixa:"Jovem",temper:"Ca√≥tico",comp:"Comunicativo",
     note:"Efeito de jogo: Ao embarcar, role um dado. O n√∫mero tirado indica quantos pontos de a√ß√£o voc√™ ter√° no seu pr√≥ximo turno."
  }),
  P({id:"edio",nome:"√âdio (O M√∫sico)",base:1,faixa:"Adulto",temper:"Tranquilo",comp:"Barulhento",
     text:"Se ele e 'A Artes√£' estiverem no mesmo bus√£o, as cartas que sobrarem na sua m√£o valem pontos positivos.",
     note:"Se ele e 'A Artes√£' estiverem no mesmo bus√£o, as cartas que sobrarem na sua m√£o valem pontos positivos."
  }),
  P({id:"isabel",nome:"Isabel (A Artes√£)",base:3,faixa:"Adulto",temper:"Tranquilo",comp:"Silencioso",
     text:"Se ela estiver em seu bus√£o no fim do jogo, as cartas em sua m√£o n√£o valem pontos negativos."
  }),
  P({id:"joao_monstrao",nome:"Jo√£o (O Monstr√£o)",base:2,faixa:"Adulto",temper:"Ca√≥tico",comp:"Barulhento",
     note:"Efeito de jogo: Neste turno voc√™ tem +2 pontos de a√ß√£o."
  }),
  P({id:"malk",nome:"Malk (O Vampiro Exc√™ntrico da marginal)",base:-3,faixa:"Adulto",temper:"Ca√≥tico",comp:"Comunicativo",
     note:"Efeito de jogo: Escolha 1 jogador para perder 1 ponto de a√ß√£o e outro para ganhar 1 ponto de a√ß√£o extra nesta rodada."
  }),
  P({id:"mateus",nome:"Mateus (O Gente Boa)",base:4,faixa:"?",temper:"?",comp:"?",
     text:"Coringa: As 3 melhores tags (1 de cada categoria) de b√¥nus do motorista/melhorias s√£o atribu√≠das a ele automaticamente."
  }),
  P({id:"elson",nome:"Elson Dion (O Ga√∫cho)",base:2,faixa:"Adulto",temper:"Equilibrado",comp:"Comunicativo",
     text:"+2 pontos por cada Comunicativo adjacente.",
     ability:(p,ctx,log)=>{ const n=ctx.countAdj(p, c=>c.comp==="Comunicativo"); if(n) log(`+${2*n} por Comunicativo adj.`); return 2*n; }
  }),
  P({id:"manuela_natan",nome:"Manuela e Natan (Os Menores Desacompanhados)",base:4,faixa:"Jovem",temper:"Ca√≥tico",comp:"Silencioso",
     text:"S√≥ embarcam e/ou pontuam no fim do jogo se estiverem adjacentes a um adulto.",
     require:(ctx,p)=> ({ok: ctx.countAdj(p, c=>c.faixa==="Adulto")>0, msg:"Precisa embarcar adjacente a um Adulto."}),
     scoreReq:(ctx,p)=> ({ok: ctx.countAdj(p,c=>c.faixa==="Adulto")>0, msg:"Precisa estar adjacente a pelo menos 1 Adulto para pontuar."})
  }),
  P({id:"beatriz",nome:"Beatriz (A Fisioterapeuta)",base:2,faixa:"Adulto",temper:"Equilibrado",comp:"Comunicativo",
     text:"Se no bus√£o estiver a melhoria 'Acessibilidade', +3 para cada idoso adjacente.",
     ability:(p,ctx,log)=>{ if(!ctx.hasImprovement("Acessibilidade")) return 0; const n=ctx.countAdj(p,c=>c.faixa==="Idoso");
       if(n){log(`+${3*n} (Acessibilidade ativa: +3 por ${n} Idoso adj.)`);} return 3*n; }
  }),
  P({id:"lucas",nome:"Lucas (O Mario do Carnaval)",base:6,faixa:"Adulto",temper:"Equilibrado",comp:"Comunicativo",
     text:"S√¥ pontua se estiver adjacente ao passageiro 'Luigi do Carnaval'.",
     scoreReq:(ctx,p)=> ({ok: ctx.countAdj(p,c=>c.id==="guilherme")>0, msg:"Precisa estar adjacente a 'Guilherme (O Luigi do Carnaval)' para pontuar."})
  }),
  P({id:"guilherme",nome:"Guilherme (O Luigi do Carnaval)",base:6,faixa:"Adulto",temper:"Equilibrado",comp:"Comunicativo",
     text:"S√¥ pontua se estiver adjacente ao passageiro 'Mario do Carnaval'.",
     scoreReq:(ctx,p)=> ({ok: ctx.countAdj(p,c=>c.id==="lucas")>0, msg:"Precisa estar adjacente a 'Lucas (O Mario do Carnaval)' para pontuar."})
  }),
  P({id:"nelson",nome:"Nelson (O Nerd Velho)",base:8,faixa:"Adulto",temper:"Tranquilo",comp:"Silencioso",
     text:"S√¥ pontua se estiver sozinho na coluna que ocupa.",
     scoreReq:(ctx,p)=> {
       const other = p.row===0 ? ctx.getPos(1,p.col) : ctx.getPos(0,p.col);
       const ok = !other.card;
       return {ok, msg:"Precisa estar sozinho na coluna para pontuar."};
     }
  }),
  P({id:"bia",nome:"Anna Beatriz (A Crossfiteira)",base:1,faixa:"Adulto",temper:"Ca√≥tico",comp:"Comunicativo",
     note:"Efeito de jogo: Pode trazer um passageiro de cada Bus√£o advers√°rio para o seu Bus√£o."
  }),
  P({id:"adrian_giovanna",nome:"Adrian e Giovanna (Os Noivos)",base:3,faixa:"Adulto",temper:"Tranquilo",comp:"Silencioso",
     text:"+1 ponto por cada passageiro adjacente.",
     ability:(p,ctx,log)=>{ const n=ctx.countAdj(p,()=>true); if(n){log(`+${n} por passageiro adj.`);} return n; }
  })
];

/* ============================
   EXPANS√ÉO ‚Äì LENDAS URBANAS
============================= */
const LENDAS_URBANAS = [
  P({id:"paula",nome:"Paula (A Loira do Banheiro)",base:1,faixa:"Adulto",temper:"Ca√≥tico",comp:"Comunicativo",
     text:"Exig√™ncia: -7 pontos se n√£o tiver a melhoria Banheiro no Bus√£o.",
     require:(ctx)=> ({ok: ctx.hasImprovement("Banheiro"), msg:"Requer a melhoria Banheiro, caso contr√°rio, -7 pontos."}),
     penalty:(p,ctx,log)=> {
       if(!ctx.hasImprovement("Banheiro")) { log("-7 por n√£o ter Banheiro"); return -7; }
       return 0;
     }
  }),
  P({id:"tomate",nome:"Tomate (O Palha√ßo Sinistro)",base:2,faixa:"Adulto",temper:"Ca√≥tico",comp:"Comunicativo",
     text:"Penalidade: Todos os idosos e jovens adjacentes desembarcam.",
     note:"Penalidade: Todos os idosos e jovens adjacentes desembarcam."
  }),
  P({id:"seu_osvaldo",nome:"Seu Osvaldo (O Velho do Saco)",base:2,faixa:"Idoso",temper:"Ca√≥tico",comp:"Barulhento",
     text:"Penalidade: -3 pontos para cada jovem e cada tranquilo no Bus√£o.",
     penalty:(p,ctx,log)=> {
       const jovens = ctx.countBus(c=>!c.isCobrador && c.faixa==="Jovem");
       const tranquilos = ctx.countBus(c=>!c.isCobrador && c.temper==="Tranquilo");
       const total = (jovens + tranquilos) * -3;
       if(total < 0) log(`${total} (-3 por cada Jovem e cada Tranquilo: ${jovens}+${tranquilos}=${jovens+tranquilos})`);
       return total;
     }
  }),
  P({id:"seu_valdir",nome:"Seu Valdir (O Lobisomem de Bairro)",base:4,faixa:"Idoso",temper:"Tranquilo",comp:"Silencioso",
     text:"Especial: Afasta os passageiros adjacentes um espa√ßo para longe. Quem n√£o tiver para onde ir, desembarca.",
     note:"Especial: Afasta os passageiros adjacentes um espa√ßo para longe. Quem n√£o tiver para onde ir, desembarca."
  }),
  P({id:"gerson",nome:"Gerson (O Fantasma do √öltimo Ponto)",base:-5,faixa:"Jovem",temper:"Equilibrado",comp:"Silencioso",
     text:"Penalidade: N√£o pode ser for√ßado a desembarcar. A n√£o ser que seja a rodada final.",
     note:"Penalidade: N√£o pode ser for√ßado a desembarcar. A n√£o ser que seja a rodada final."
  })
];

/* ============================
   EXPANS√ÉO ‚Äì GRUPO DE PAGODE
============================= */
const GRUPO_PAGODE = [
  P({id:"dudu",nome:"Dudu (O Pagodeiro no Cavaquinho)",base:2,faixa:"Jovem",temper:"Equilibrado",comp:"Comunicativo",
     text:"Penalidade: Pode fazer um pagodeiro de outro Bus√£o desembarcar.",
     note:"Penalidade: Pode fazer um pagodeiro de outro Bus√£o desembarcar."
  }),
  P({id:"zeca",nome:"Zeca (O Pagodeiro no Pandeiro)",base:3,faixa:"Adulto",temper:"Tranquilo",comp:"Barulhento",
     text:"Especial: Pode ativar novamente o efeito de embarque de outro passageiro j√° embarcado em seu Bus√£o.",
     note:"Especial: Pode ativar novamente o efeito de embarque de outro passageiro j√° embarcado em seu Bus√£o."
  }),
  P({id:"thiago",nome:"Thiago (O Pagodeiro no Tamborim)",base:4,faixa:"Jovem",temper:"Ca√≥tico",comp:"Silencioso",
     text:"Especial: Pode trocar de lugar com algum outro passageiro no Bus√£o 1 vez a qualquer momento do jogo.",
     note:"Especial: Pode trocar de lugar com algum outro passageiro no Bus√£o 1 vez a qualquer momento do jogo."
  }),
  P({id:"arlindo",nome:"Arlindo (O Pagodeiro no Tantan)",base:5,faixa:"Adulto",temper:"Equilibrado",comp:"Silencioso",
     text:"Exig√™ncia: S√≥ embarca se outro passageiro do grupo de Pagode j√° estiver no Bus√£o.",
     require:(ctx)=> ({ok: ctx.countBus(c=>c.id && GRUPO_PAGODE.map(g=>g.id).includes(c.id)) > 0, msg:"Requer outro pagodeiro no bus√£o."})
  }),
  P({id:"xande",nome:"Xande (O Pagodeiro no Reco-reco)",base:1,faixa:"Adulto",temper:"Ca√≥tico",comp:"Comunicativo",
     text:"Especial: Pode fazer um outro pagodeiro da sua m√£o embarcar sem custo.",
     note:"Especial: Pode fazer um outro pagodeiro da sua m√£o embarcar sem custo."
  })
];

/* ============================
   UI refs
============================= */
const byName = (a,b)=> a.nome.localeCompare(b.nome);
const DRIVER_SEL = document.getElementById("driver");
const EXP_COB = document.getElementById("expCobradores");
const EXP_APX = document.getElementById("expApaixonados");
const EXP_PERR = document.getElementById("expPerrengues");
const EXP_ESTOU_NO_BUSAO = document.getElementById("expEstouNoBusao");
const EXP_LENDAS_URBANAS = document.getElementById("expLendasUrbanas");
const EXP_GRUPO_PAGODE = document.getElementById("expGrupoPagode");
const EXP_ROTAS_DIARIAS = document.getElementById("expRotasDiarias");
const DRIVER_INFO = document.getElementById("driverInfo");
const IMPROV_BUTTONS_WRAP = document.getElementById("improvButtons");
const IMPROV_INFO = document.getElementById("improvInfo");
const PERR_SECTION = document.getElementById("perrenguesSection");
const PERR_BUTTONS_WRAP = document.getElementById("perrenguesButtons");
const PERR_INFO = document.getElementById("perrenguesInfo");
const ROTAS_DIARIAS_SECTION = document.getElementById("rotasDiariasSection");
const ROTAS_DIARIAS_BUTTONS_WRAP = document.getElementById("rotasDiariasButtons");
const ROTAS_DIARIAS_INFO = document.getElementById("rotasDiariasInfo");
const GRID = document.getElementById("grid");
const EXPLAIN = document.getElementById("explain");
const totalScoreEl = document.getElementById("totalScore");
const sumPassengersEl = document.getElementById("sumPassengers");
const sumDriverEl = document.getElementById("sumDriver");
const sumImprovEl = document.getElementById("sumImprov");
const sumPerrenguesEl = document.getElementById("sumPerrengues");
const sumRotasDiariasEl = document.getElementById("sumRotasDiarias");
const sumHandEl = document.getElementById("sumHand");
const warningsEl = document.getElementById("warnings");
const playerNameEl = document.getElementById("playerName");
const playerTagEl = document.getElementById("playerTag");
const handCountEl = document.getElementById("handCount");
const rankTableBody = document.querySelector("#rankTable tbody");
const btnClearSeats = document.getElementById("btnClearSeats");
const btnNewRound = document.getElementById("btnNewRound");
const btnSaveScore = document.getElementById("btnSaveScore");
const btnResetRanking = document.getElementById("btnResetRanking");

/* ======= Abas (topo) ======= */
const topTabBtns = Array.from(document.querySelectorAll(".tabs-top .tabbtn"));
const topViews = {
  "tab-config": document.getElementById("tab-config"),
  "tab-seats": document.getElementById("tab-seats"),
  "tab-catalog": document.getElementById("tab-catalog"),
  "tab-regrasfaq": document.getElementById("tab-regrasfaq"),
};
topTabBtns.forEach(b=>{
  b.onclick = ()=>{
    topTabBtns.forEach(x=>x.classList.toggle("act", x===b));
    Object.entries(topViews).forEach(([k,el])=> el.classList.toggle("act", k===b.dataset.tab));
  };
});

/* ======= Abinhas internas (Regras/FAQ) ======= */
const itabBtns = Array.from(document.querySelectorAll(".itab"));
const itabPans = { regras: document.querySelector(".rules-container"), faq: document.getElementById("itab-faq") };
itabBtns.forEach(b=>{
    b.onclick = ()=>{
        itabBtns.forEach(x=> x.classList.remove("act"));
        b.classList.add("act");
        Object.entries(itabPans).forEach(([k,el]) => {
            if (el) el.style.display = k === b.dataset.itab ? 'block' : 'none';
        });
        itabBtns.forEach(x=> {
            const isAct = x.classList.contains("act");
            x.style.borderBottomColor = isAct ? "#60a5fa" : "transparent";
            x.style.color = isAct ? "#60a5fa" : "#cbd5e1";
        });
    };
});

/* ============================
   INIT CONFIG
============================= */
function buildOptions(list){
  const frag = document.createDocumentFragment();
  list.forEach(x=>{ const opt = document.createElement("option"); opt.value=x.id; opt.textContent=x.nome; frag.appendChild(opt); });
  return frag;
}

function mountLeft(){
  DRIVER_SEL.appendChild(buildOptions(DRIVERS));
  DRIVER_SEL.addEventListener("change", ()=>{ renderDriverInfo(); render(); });
  
  EXP_COB.addEventListener("change", ()=>{ rebuildSeatSelectOptions(); refreshSeatSelects(); render(); });
  EXP_APX.addEventListener("change", ()=>{ rebuildSeatSelectOptions(); refreshSeatSelects(); render(); });
  EXP_ESTOU_NO_BUSAO.addEventListener("change", ()=>{ rebuildSeatSelectOptions(); refreshSeatSelects(); render(); });
  EXP_LENDAS_URBANAS.addEventListener("change", ()=>{ rebuildSeatSelectOptions(); refreshSeatSelects(); render(); });
  EXP_GRUPO_PAGODE.addEventListener("change", ()=>{ rebuildSeatSelectOptions(); refreshSeatSelects(); render(); });
  
  EXP_PERR.addEventListener("change", ()=>{ 
    PERR_SECTION.style.display = EXP_PERR.checked ? "block" : "none";
    if (EXP_PERR.checked) {
      buildPerrengueButtons();
    } else {
      selectedPerrengueIds.clear();
    }
    render(); 
  });
  
  EXP_ROTAS_DIARIAS.addEventListener("change", ()=>{ 
    ROTAS_DIARIAS_SECTION.style.display = EXP_ROTAS_DIARIAS.checked ? "block" : "none";
    if (EXP_ROTAS_DIARIAS.checked) {
      buildRotasDiariasButtons();
    } else {
      selectedRotasDiariasIds.clear();
    }
    render(); 
  });

  buildImprovementButtons();

  playerNameEl.addEventListener("input", ()=>{ playerTagEl.textContent = playerNameEl.value? `Jogador: ${playerNameEl.value}`:""; });
  handCountEl.addEventListener("input", render);
  renderDriverInfo();
}

function renderDriverInfo(){
  const d = DRIVERS.find(x=>x.id===DRIVER_SEL.value);
  if(!d || !d.id){
    DRIVER_INFO.innerHTML = `<div class="driver-card"><div><b>Sem motorista</b></div><div class="muted">Selecione um motorista para ativar o b√¥nus.</div></div>`;
  }else{
    DRIVER_INFO.innerHTML = `<div class="driver-card"><div><b>${d.nome}</b></div><div class="muted">+1 por cada ocorr√™ncia de: ${d.bonus.join(" ‚Ä¢ ")}</div></div>`;
  }
  renderImprovInfo();
}

/* ======= Melhorias como BOT√ïES ======= */
let selectedImprovementIds = new Set();
function buildImprovementButtons(){
  IMPROV_BUTTONS_WRAP.innerHTML = "";
  IMPROVEMENTS.forEach(imp=>{
    const b = document.createElement("button");
    b.type="button";
    b.className = "btn btn-toggle btn-pill";
    b.textContent = imp.nome;
    b.onclick = ()=>{
      if(selectedImprovementIds.has(imp.id)){
        selectedImprovementIds.delete(imp.id);
        b.classList.remove("sel");
      }else{
        if(selectedImprovementIds.size>=3){
          alert("Voc√™ j√° selecionou 3 melhorias. Desmarque uma para escolher outra.");
          return;
        }
        selectedImprovementIds.add(imp.id);
        b.classList.add("sel");
      }
      renderImprovInfo();
      refreshSeatSelects();
      render();
    };
    IMPROV_BUTTONS_WRAP.appendChild(b);
  });
}

function getImprovements(){
  return [...selectedImprovementIds].map(id=>IMPROVEMENTS.find(i=>i.id===id)).filter(Boolean);
}

function renderImprovInfo(){
  const imps = getImprovements();
  IMPROV_INFO.innerHTML = imps.length
    ? imps.map(i => `<div class="improv-card"><div><b>${i.nome}</b></div><div class="muted">+1 por cada ocorr√™ncia de: ${i.bonus.join(" ‚Ä¢ ")}</div></div>`).join("")
    : `<div class="improv-card"><div><b>Nenhuma melhoria selecionada</b></div><div class="muted">Voc√™ pode ativar at√© 3 melhorias.</div></div>`;
}

/* ======= Perrengues como BOT√ïES ======= */
let selectedPerrengueIds = new Set();
function buildPerrengueButtons(){
  PERR_BUTTONS_WRAP.innerHTML = "";
  PERRENGUES.forEach(perr=>{
    const b = document.createElement("button");
    b.type="button";
    b.className = "btn btn-toggle btn-pill";
    b.textContent = perr.nome;
    b.onclick = ()=>{
      if(selectedPerrengueIds.has(perr.id)){
        selectedPerrengueIds.delete(perr.id);
        b.classList.remove("sel");
      }else{
        selectedPerrengueIds.add(perr.id);
        b.classList.add("sel");
      }
      renderPerrengueInfo();
      render();
    };
    PERR_BUTTONS_WRAP.appendChild(b);
  });
}

function getPerrengues(){
  return [...selectedPerrengueIds].map(id=>PERRENGUES.find(p=>p.id===id)).filter(Boolean);
}

function renderPerrengueInfo(){
  const perrengues = getPerrengues();
  PERR_INFO.innerHTML = perrengues.length
    ? perrengues.map(p => `<div class="improv-card"><div><b>${p.nome}</b></div><div class="muted">${p.efeito}</div></div>`).join("")
    : `<div class="improv-card"><div><b>Nenhum perrengue selecionado</b></div><div class="muted">Selecione os perrengues ativos.</div></div>`;
}

/* ======= Rotas Di√°rias como BOT√ïES ======= */
let selectedRotasDiariasIds = new Set();
function buildRotasDiariasButtons(){
  ROTAS_DIARIAS_BUTTONS_WRAP.innerHTML = "";
  ROTAS_DIARIAS.forEach(rota=>{
    const b = document.createElement("button");
    b.type="button";
    b.className = "btn btn-toggle btn-pill";
    b.textContent = rota.nome;
    b.onclick = ()=>{
      if(selectedRotasDiariasIds.has(rota.id)){
        selectedRotasDiariasIds.delete(rota.id);
        b.classList.remove("sel");
      }else{
        selectedRotasDiariasIds.add(rota.id);
        b.classList.add("sel");
      }
      renderRotasDiariasInfo();
      render();
    };
    ROTAS_DIARIAS_BUTTONS_WRAP.appendChild(b);
  });
}

function getRotasDiarias(){
  return [...selectedRotasDiariasIds].map(id=>ROTAS_DIARIAS.find(r=>r.id===id)).filter(Boolean);
}

function renderRotasDiariasInfo(){
  const rotas = getRotasDiarias();
  ROTAS_DIARIAS_INFO.innerHTML = rotas.length
    ? rotas.map(r => `<div class="improv-card"><div><b>${r.nome}</b></div><div class="muted">${r.efeito}</div></div>`).join("")
    : `<div class="improv-card"><div><b>Nenhuma rota di√°ria selecionada</b></div><div class="muted">Selecione as rotas di√°rias ativas.</div></div>`;
}

/* ============================
   GRID 2 √ó 6 (com selects escondidos)
============================= */
const ROWS=2, COLS=6;

function mountGrid(){
  GRID.innerHTML="";
  for(let r=0;r<ROWS;r++){
    for(let c=0;c<COLS;c++){
      const seatNo = r===0 ? (c+1) : (6+c+1);
      const seat = document.createElement("div");
      seat.className="seat";
      seat.dataset.row=r; seat.dataset.col=c; seat.dataset.seatno=seatNo;

      const pos = document.createElement("div"); pos.className="pos"; pos.textContent = `Assento ${seatNo}`; seat.appendChild(pos);

      const slot = document.createElement("div"); slot.className="slot";
      const sel = document.createElement("select");
      sel.className = "hidden-select seat-select"; // escondido; controlado pelo modal
      sel.appendChild(buildCardOptions(
        EXP_COB.checked, 
        EXP_APX.checked, 
        EXP_ESTOU_NO_BUSAO.checked,
        EXP_LENDAS_URBANAS.checked,
        EXP_GRUPO_PAGODE.checked
      ));
      sel.dataset.row=r; sel.dataset.col=c;

      sel.addEventListener("change", ()=>{
        const chosen = findAnyCard(sel.value);
        name.textContent = chosen ? chosen.nome : " Adicionar ";
        refreshSeatSelects();
        updateBusVisualLabels(collectState());
        render();
      });

      const name = document.createElement("div");
      name.className="slot-name muted"; name.textContent = "Adicionar ";

      seat.addEventListener("click", (ev)=>{
        if(ev.target.tagName.toLowerCase()==="select") return;
        openPickerForSeat(seatNo);
      });

      slot.appendChild(sel); seat.appendChild(slot); seat.appendChild(name); GRID.appendChild(seat);
    }
  }
  refreshSeatSelects();
}

/* Op√ß√µes por select */
function buildCardOptions(includeCobradores, includeApaixonados, includeEstouNoBusao, includeLendasUrbanas, includeGrupoPagode){
  const frag = document.createDocumentFragment();
  const empty = document.createElement("option"); empty.value=""; empty.textContent="‚Äî vazio ‚Äî"; frag.appendChild(empty);
  
  const ogPass = document.createElement("optgroup"); ogPass.label="Passageiros";
  CARD_DB.slice().sort(byName).forEach(x=>{ const o=document.createElement("option"); o.value=x.id; o.textContent=x.nome; ogPass.appendChild(o); });
  frag.appendChild(ogPass);

  if(includeCobradores){
    const ogCob = document.createElement("optgroup"); ogCob.label="Cobradores (expans√£o)";
    COBRADORES.slice().sort(byName).forEach(x=>{ const o=document.createElement("option"); o.value=x.id; o.textContent=x.nome; ogCob.appendChild(o); });
    frag.appendChild(ogCob);
  }
  if(includeApaixonados){
    const ogApx = document.createElement("optgroup"); ogApx.label="Os Apaixonados (expans√£o)";
    APAIXONADOS.slice().sort(byName).forEach(x=>{ const o=document.createElement("option"); o.value=x.id; o.textContent=x.nome; ogApx.appendChild(o); });
    frag.appendChild(ogApx);
  }
  if(includeEstouNoBusao){
    const ogEstou = document.createElement("optgroup"); ogEstou.label="Estou no Bus√£o (expans√£o)";
    ESTOU_NO_BUSAO.slice().sort(byName).forEach(x=>{ const o=document.createElement("option"); o.value=x.id; o.textContent=x.nome; ogEstou.appendChild(o); });
    frag.appendChild(ogEstou);
  }
  if(includeLendasUrbanas){
    const ogLendas = document.createElement("optgroup"); ogLendas.label="Lendas Urbanas (expans√£o)";
    LENDAS_URBANAS.slice().sort(byName).forEach(x=>{ const o=document.createElement("option"); o.value=x.id; o.textContent=x.nome; ogLendas.appendChild(o); });
    frag.appendChild(ogLendas);
  }
  if(includeGrupoPagode){
    const ogPagode = document.createElement("optgroup"); ogPagode.label="Grupo de Pagode (expans√£o)";
    GRUPO_PAGODE.slice().sort(byName).forEach(x=>{ const o=document.createElement("option"); o.value=x.id; o.textContent=x.nome; ogPagode.appendChild(o); });
    frag.appendChild(ogPagode);
  }
  return frag;
}

function rebuildSeatSelectOptions(){
  GRID.querySelectorAll("select.seat-select").forEach(sel=>{
    const prev = sel.value;
    sel.innerHTML = "";
    sel.appendChild(buildCardOptions(
      EXP_COB.checked, 
      EXP_APX.checked, 
      EXP_ESTOU_NO_BUSAO.checked,
      EXP_LENDAS_URBANAS.checked,
      EXP_GRUPO_PAGODE.checked
    ));
    
    const cardStillExists = !!findAnyCard(prev);
    sel.value = cardStillExists ? prev : "";
    
    const nameEl = sel.parentElement.nextElementSibling;
    const currentCard = findAnyCard(sel.value);
    if(nameEl) nameEl.textContent = currentCard ? currentCard.nome : " Adicionar ";
  });
}

/* ======= DUPLICATAS ======= */
function getSelectedCardIds(){
  const ids=[]; GRID.querySelectorAll("select.seat-select").forEach(s=>{ if(s.value) ids.push(s.value); });
  return ids;
}

function allowDuplicate(id){
  const card = findAnyCard(id); return !!card?.allowDup;
}

function isCardSelectedElsewhere(id, sel){
  let dup=false;
  GRID.querySelectorAll("select.seat-select").forEach(s=>{
    if(s!==sel && s.value===id) dup=true;
  });
  return dup && !allowDuplicate(id);
}

/* ======= COBRADORES: s√≥ 1 ======= */
function countSelectedCobradores(exceptSel=null){
  let n=0;
  GRID.querySelectorAll("select.seat-select").forEach(s=>{
    if(exceptSel && s===exceptSel) return;
    if(isCobradorId(s.value)) n++;
  });
  return n;
}

function anyCobradorSelected(exceptSel=null){ return countSelectedCobradores(exceptSel)>0; }

/* helpers posi√ß√£o */
function otherPos(pos){ return {row: pos.row===0?1:0, col: pos.col}; }
function seatNumToRC(n){ if(n<=6) return {row:0,col:n-1}; return {row:1,col:n-7}; }

function isSeatBlockedByWilson(pos){
  const other = otherPos(pos);
  const otherSel = GRID.querySelector(`select.seat-select[data-row="${other.row}"][data-col="${other.col}"]`);
  return otherSel && otherSel.value==="wilson";
}

/* ============================
   CONTEXTO (cartas ativas)
============================= */
function buildCtx(state){
  const warnings = [];
  const memo = new Map();
  const key = (r,c)=> `${r},${c}`;
  const getPos = (r,c)=> state.grid[r][c];
  
  function neighbors(pos){
    const out=[];
    if(pos.col-1>=0) out.push({row:pos.row,col:pos.col-1});
    if(pos.col+1<COLS) out.push({row:pos.row,col:pos.col+1});
    const other = pos.row===0?1:0;
    for(let dc=-1; dc<=1; dc++){
      const cc = pos.col+dc;
      if(cc>=0 && cc<COLS) out.push({row:other,col:cc});
    }
    return out;
  }

  function isActiveAt(pos){
    const k = key(pos.row,pos.col);
    if(memo.has(k)) return memo.get(k);
    const card = getPos(pos.row,pos.col).card;
    let ok = false;
    if(card){
      if(typeof card.require === "function"){
        const proxy = {
          grid: state.grid,
          improvements: state.improvements,
          driver: state.driver,
          hasImprovement: (name)=> state.improvements.some(i=>i.nome===name),
          getPos,
          countBus: (pred)=> countBusActive(pred),
          countAdj: (p,pred)=> countAdjActive(p,pred),
          countAdjEmpty: (p)=> countAdjEmptyActive(p),
          countAheadBothRows: (p)=> countAheadBothRowsActive(p),
          existsId: (id)=> existsIdActive(id),
          isActiveAt: (p)=> isActiveAt(p),
        };
        try{ ok = !!card.require(proxy, pos)?.ok; }catch{ ok = false; }
      }else{
        ok = true;
      }
    }
    memo.set(k, ok);
    return ok;
  }

  function forEachActive(fn){
    for(let r=0;r<ROWS;r++) for(let c=0;c<COLS;c++){
      const card = state.grid[r][c].card;
      if(card && isActiveAt({row:r,col:c})) fn({row:r,col:c}, card);
    }
  }

  function countBusActive(pred){ let n=0; forEachActive((p,card)=>{ if(pred(card,p)) n++; }); return n; }
  
  function neighborsList(pos){ return neighbors(pos); }
  
  function countAdjActive(pos,pred){
    let n=0; for(const nb of neighbors(pos)){ const card = state.grid[nb.row][nb.col].card; if(card && isActiveAt(nb) && pred(card, nb)) n++; } return n;
  }
  
  function countAdjEmptyActive(pos){
    let n=0; for(const nb of neighbors(pos)){ const card = state.grid[nb.row][nb.col].card; if(!card || !isActiveAt(nb)) n++; } return n;
  }
  
  function countAheadBothRowsActive(pos){
    let n=0; for(let c=0;c<pos.col;c++){
      const a = {row:0,col:c}, b={row:1,col:c};
      if(state.grid[a.row][a.col].card && isActiveAt(a)) n++;
      if(state.grid[b.row][b.col].card && isActiveAt(b)) n++;
    } return n;
  }
  
  function existsIdActive(id){ let found=false; forEachActive((p,c)=>{ if(c.id===id) found=true; }); return found; }

  const ctx = {
    grid: state.grid,
    improvements: state.improvements,
    driver: state.driver,
    perrengues: state.perrengues,
    rotasDiarias: state.rotasDiarias,
    warn: (msg)=>warnings.push(msg),
    hasImprovement: (name)=> state.improvements.some(i=>i.nome===name),
    existsId: existsIdActive,
    getPos,
    forEachCard: forEachActive,
    countBus: (pred)=> countBusActive(pred),
    countAdj: (pos,pred)=> countAdjActive(pos,pred),
    countAdjEmpty: (pos)=> countAdjEmptyActive(pos),
    countAheadBothRows: (pos)=> countAheadBothRowsActive(pos),
    neighbors: neighborsList,
    isActiveAt,
  };
  return {ctx, warnings, isActiveAt};
}

function collectState(){
  const grid = [...Array(ROWS)].map(()=>[...Array(COLS)].map(()=>({card:null})));
  GRID.querySelectorAll("select.seat-select").forEach(sel=>{
    const id = sel.value; const r=+sel.dataset.row, c=+sel.dataset.col;
    grid[r][c].card = id ? findAnyCard(id) : null;
  });
  const d = DRIVERS.find(x=>x.id===DRIVER_SEL.value);
  const driver = d && d.id ? d : null;
  const improvements = getImprovements();
  const perrengues = getPerrengues();
  const rotasDiarias = getRotasDiarias();
  const hand = Math.max(0, +handCountEl.value||0);
  return {grid, driver, improvements, perrengues, rotasDiarias, hand};
}

function findAnyCard(id){ 
  if(!id) return null; 
  return CARD_DB.find(x=>x.id===id) || 
         COBRADORES.find(x=>x.id===id) || 
         APAIXONADOS.find(x=>x.id===id) ||
         ESTOU_NO_BUSAO.find(x=>x.id===id) ||
         LENDAS_URBANAS.find(x=>x.id===id) ||
         GRUPO_PAGODE.find(x=>x.id===id) ||
         null; 
}

function isCobradorId(id){ return !!COBRADORES.find(x=>x.id===id); }
function isApaixonadoId(id){ return !!APAIXONADOS.find(x=>x.id===id); }
function isEstouNoBusaoId(id){ return !!ESTOU_NO_BUSAO.find(x=>x.id===id); }
function isLendaId(id){ return !!LENDAS_URBANAS.find(x=>x.id===id); }
function isPagodeId(id){ return !!GRUPO_PAGODE.find(x=>x.id===id); }

/* ======= Regras de embarque por posi√ß√£o ======= */
function hasCobradorElsewhere(state, pos){
  let n=0;
  for(let r=0;r<ROWS;r++) for(let c=0;c<COLS;c++){
    if(r===pos.row && c===pos.col) continue;
    const card = state.grid[r][c].card;
    if(card && card.isCobrador) n++;
  }
  return n>0;
}

function checkCardAllowedAt(card, pos, state){
  if(!card) return {ok:true};
  
  if(!card.allowDup && !card.isApaixonado){
    let dup=false;
    GRID.querySelectorAll("select.seat-select").forEach(s=>{
      if(+s.dataset.row===pos.row && +s.dataset.col===pos.col) return;
      if(s.value===card.id) dup=true;
    });
    if(dup) return {ok:false, reason:"Voc√™ j√° colocou esta carta em outro assento."};
  }
  
  if(isSeatBlockedByWilson(pos) && card.id!==""){
    return {ok:false, reason:"O Wilson est√° no √¥nibus e ocupa os 2 lugares desta coluna. Deixe este assento vazio."};
  }
  
  if(card.isCobrador && hasCobradorElsewhere(state, pos)){
    return {ok:false, reason:"S√¥ √© permitido 1 cobrador por √¥nibus."};
  }
  
  if(typeof card.require === "function"){
    const {ctx} = buildCtx(state);
    try{
      const rq = card.require(ctx, pos);
      if(!rq.ok) return {ok:false, reason: rq.msg || "Exig√™ncia n√£o atendida para embarcar."};
    }catch(e){
      return {ok:false, reason:"Exig√™ncia n√£o atendida para embarcar."};
    }
  }
  
  return {ok:true};
}

/* ============================
   BUS VISUAL
============================= */
const BUS_SEATS = document.getElementById("busVisualSeats");
let currentBusFocus = null;

function mountBusVisual(){
  BUS_SEATS.innerHTML = "";
  for(let n=1;n<=12;n++){
    const b = document.createElement("button");
    b.type="button"; b.className="bseat"; b.textContent = n;
    b.dataset.seatno = n;
    b.addEventListener("click", ()=>{ focusGridSeat(n,true); openPickerForSeat(n); });
    BUS_SEATS.appendChild(b);
  }
  document.getElementById("btnVisualHelp").onclick=()=>document.getElementById("visualHelp").classList.toggle("open");
}

function updateBusVisualLabels(state){
  const items = BUS_SEATS.querySelectorAll(".bseat");
  items.forEach(el=>{
    const n = +el.dataset.seatno;
    const {row,col} = seatNumToRC(n);
    const card = state.grid[row][col].card;
    const label = card ? `${n} ‚Äî ${card.nome}` : `${n} ‚Äî Vazio`;
    el.setAttribute("data-label", label);
    el.setAttribute("aria-current", currentBusFocus===n ? "true" : "false");
    el.classList.toggle("occ", !!card);
  });
}

function seatNumber(pos){ return pos.row===0 ? (pos.col+1) : (6+pos.col+1); }

function focusGridSeat(n, fromBus=false){
  const {row,col} = seatNumToRC(n);
  const seatEl = GRID.querySelector(`.seat[data-row="${row}"][data-col="${col}"]`);
  if(seatEl){
    seatEl.classList.add("hl");
    setTimeout(()=> seatEl.classList.remove("hl"), 700);
    if(fromBus){ currentBusFocus = n; updateBusVisualLabels(collectState()); }
    seatEl.scrollIntoView({behavior:"smooth", block:"center"});
    scrollExplainToSeat(n);
  }
}

/* ============================
   Pontua√ß√£o
============================= */
function scoreDriver(state, ctx){
  if(!state.driver) return 0;
  const b = state.driver.bonus;
  let n=0;
  
  // Para cada tag do motorista, contar quantas cartas t√™m essa tag
  b.forEach(tag => {
    ctx.forEachCard((p,c)=>{ 
      if(c.isCobrador || c.id === 'mateus') return;
      if(c.faixa === tag || c.temper === tag || c.comp === tag) n++;
    });
  });
  
  const hasVovoMichel = ctx.existsId("vovo_michel");
  if(hasVovoMichel) {
    n = n * 2;
  }
  
  return n;
}

function scoreImprovements(state, ctx, breakdown){
  const fausta = ctx.existsId("dona_fausta");
  if(fausta) return {score:0, note:"Dona Fausta presente: melhorias n√£o pontuam."};
  let s=0;
  state.improvements.forEach(imp=>{
    let k=0;
    // Para cada tag da melhoria, contar quantas cartas t√™m essa tag
    imp.bonus.forEach(tag => {
      ctx.forEachCard((p,c)=>{ 
        if(c.isCobrador || c.id === 'mateus') return;
        if(c.faixa === tag || c.temper === tag || c.comp === tag) k++;
      });
    });
    breakdown.push({who:`[Melhoria] ${imp.nome}`, delta:+k, detail:`+${k} por correspond√™ncias no bus√£o (somente cartas ativas)`});
    s+=k;
  });
  return {score:s};
}

function calculateMateusBonus(state) {
  const TAG_CATEGORIES = {
    faixa: ['Idoso', 'Adulto', 'Jovem'],
    temper: ['Ca√≥tico', 'Equilibrado', 'Tranquilo'],
    comp: ['Barulhento', 'Comunicativo', 'Silencioso']
  };

  const allTags = [].concat(...Object.values(TAG_CATEGORIES));
  const tagPoints = Object.fromEntries(allTags.map(tag => [tag, 0]));

  if (state.driver) {
    state.driver.bonus.forEach(tag => {
      if (tag in tagPoints) tagPoints[tag]++;
    });
  }
  
  const fausta = state.grid.flat().some(cell => cell.card && cell.card.id === 'dona_fausta');
  if (!fausta) {
    state.improvements.forEach(imp => {
      imp.bonus.forEach(tag => {
        if (tag in tagPoints) tagPoints[tag]++;
      });
    });
  }

  let totalBonus = 0;
  const chosenTags = [];
  const breakdown = [];

  for (const category in TAG_CATEGORIES) {
    let bestTag = TAG_CATEGORIES[category][0];
    let maxPoints = 0;

    TAG_CATEGORIES[category].forEach(tag => {
      if (tagPoints[tag] > maxPoints) {
        maxPoints = tagPoints[tag];
        bestTag = tag;
      }
    });
    
    totalBonus += maxPoints;
    chosenTags.push(bestTag);
    breakdown.push(`${bestTag} (+${maxPoints})`);
  }

  return { score: totalBonus, chosenTags, breakdown: breakdown.join(' ‚Ä¢ ') };
}

function scorePerrengues(state, ctx, breakdown) {
  let total = 0;
  
  state.perrengues.forEach(perr => {
    let pontos = 0;
    let detalhe = "";
    
    if (perr.id === "acidente") {
      if (state.driver) {
        const contagens = {};
        state.driver.bonus.forEach(categoria => {
          contagens[categoria] = ctx.countBus(c => 
            !c.isCobrador && 
            (c.faixa === categoria || c.temper === categoria || c.comp === categoria)
          );
        });
        
        let categoriaMaior = "";
        let maiorContagem = 0;
        for (const [categoria, contagem] of Object.entries(contagens)) {
          if (contagem > maiorContagem) {
            maiorContagem = contagem;
            categoriaMaior = categoria;
          }
        }
        
        if (categoriaMaior) {
          pontos = maiorContagem;
          detalhe = `Dobrou a categoria ${categoriaMaior} do motorista: +${pontos}`;
        }
      }
    } else {
      const count = ctx.countBus(c => 
        !c.isCobrador && 
        perr.bonus.some(tag => c.faixa === tag || c.temper === tag || c.comp === tag)
      );
      
      pontos = count * perr.pontos;
      const sinal = perr.pontos > 0 ? "+" : "";
      detalhe = `${sinal}${perr.pontos} por cada ${perr.bonus.join("/")}: ${count} √ó ${perr.pontos} = ${pontos}`;
    }
    
    breakdown.push({who: `[Perrengue] ${perr.nome}`, delta: pontos, detail: detalhe});
    total += pontos;
  });
  
  return {score: total};
}

function scoreRotasDiarias(state, ctx, breakdown) {
  let total = 0;
  
  state.rotasDiarias.forEach(rota => {
    let pontos = 0;
    if (rota.condicao(ctx)) {
      pontos = rota.pontos;
      breakdown.push({who: `[Rota Di√°ria] ${rota.nome}`, delta: pontos, detail: rota.efeito});
    }
    total += pontos;
  });
  
  return {score: total};
}

function apaixonadosBonus(state, ctx){
  if(!EXP_APX.checked) return {score:0, parts:[]};

  const nodes = [];
  ctx.forEachCard((pos, card)=>{
    if(card.isApaixonado){ nodes.push({pos, card}); }
  });
  if(nodes.length<2) return {score:0, parts:[]};

  const visited = new Set();
  const groups = [];
  const key = (p)=> `${p.row},${p.col}`;

  const isApxAt = (p)=> {
    const cell = state.grid[p.row][p.col];
    return cell && cell.card && cell.card.isApaixonado;
  };

  for(const n of nodes){
    const k = key(n.pos);
    if(visited.has(k)) continue;
    const q=[n.pos]; visited.add(k);
    const group=[];
    while(q.length){
      const cur = q.shift();
      const card = state.grid[cur.row][cur.col].card;
      group.push({pos:cur, card});
      for(const nb of ctx.neighbors(cur)){
        const kk = key(nb);
        if(!visited.has(kk) && isApxAt(nb)) { visited.add(kk); q.push(nb); }
      }
    }
    groups.push(group);
  }

  let totalBonus=0; const parts=[]; let idx=1;
  for(const g of groups){
    if(g.length>=2){
      const sumBase = g.reduce((acc,x)=> acc + (x.card.base||0), 0);
      const bonus = sumBase;
      if(bonus>0){
        totalBonus += bonus;
        const seats = g.map(x=> seatNumber(x.pos)).sort((a,b)=>a-b).join(", ");
        parts.push({who:`[Apaixonados] Grupo ${idx} (assentos ${seats})`, delta:+bonus, detail:`B√¥nus de dobro da soma base: ${sumBase} ‚Üí +${bonus}`});
        idx++;
      }
    }
  }
  return {score: totalBonus, parts};
}

function grupoPagodeBonus(state, ctx){
  if(!EXP_GRUPO_PAGODE.checked) return {score:0, note:""};
  
  const pagodeiros = [];
  ctx.forEachCard((p,c)=>{
    if(GRUPO_PAGODE.some(g=>g.id===c.id)) pagodeiros.push(c);
  });
  
  if(pagodeiros.length === 5){
    return {score:50, note:"Grupo de Pagode completo! +50 pontos extras!"};
  }
  
  return {score:0, note:""};
}

/* ============================
   Render / detalhes
============================= */
function cardStaticInfo(card){
  const attrs = card.isCobrador ? "[Cobrador]" : card.isApaixonado ? "[Apaixonado]" : `${card.faixa}, ${card.temper}, ${card.comp}.`;
  const pts = `${card.base} ponto${card.base===1?"":"s"}.`;
  let label = "Efeito";
  if(card.isCobrador) label="Habilidade";
  else if(card.isApaixonado) label = "Apaixonado";
  else if(card.impacto.includes("durante") && card.text && /Ao embarcar/i.test(card.text)) label = "Condi√ß√£o";
  else if(card.require && !card.ability && !card.penalty) label = "Exig√™ncia";
  else if(card.scoreReq && !card.ability && !card.penalty) label = "Condi√ß√£o de pontua√ß√£o";
  else if(card.penalty && !card.ability) label = "Penalidade";
  else if(card.ability) label = "Habilidade";
  const textLine = card.text ? `\n${label}: ${card.text}` : "";
  return `${attrs} ${pts}${textLine}`;
}

function render(){
  const state = collectState();
  const {ctx, warnings, isActiveAt} = buildCtx(state);
  updateBusVisualLabels(state);

  const rows=[]; let passengersScore=0;

  for(let r=0;r<ROWS;r++){
    for(let c=0;c<COLS;c++){
      const card = state.grid[r][c].card;
      if(!card) continue;
      const pos = {row:r,col:c};

      if(!isActiveAt(pos) && typeof card.require==="function"){
        const rq = card.require(ctx,pos) || {ok:false,msg:"Exig√™ncia n√£o atendida."};
        const msg = `<span class="req-badge">Exig√™ncia n√£o atendida</span> <span class="req-text">${rq.msg || ""}</span>\n${cardStaticInfo(card)}`;
        rows.push(rowLine(`Assento ${seatNumber(pos)} ‚Äî ${card.nome}`, 0, msg, seatNumber(pos), "req"));
        continue;
      }
      
      if (card.id === 'mateus') {
        const mateusBonus = calculateMateusBonus(state);
        const totalMateus = card.base + mateusBonus.score;
        passengersScore += totalMateus;
        
        let detail = cardStaticInfo(card);
        if (mateusBonus.score > 0) {
          detail += `\nB√¥nus Coringa: +${mateusBonus.score}. Tags escolhidas: ${mateusBonus.breakdown}.`;
        } else {
          detail += `\nB√¥nus Coringa: +0. <span class="req-text">Selecione um motorista ou melhorias para calcular o b√¥nus ideal.</span>`;
        }
        rows.push(rowLine(`Assento ${seatNumber(pos)} ‚Äî ${card.nome}`, totalMateus, detail, seatNumber(pos)));
        continue;
      }

      let s = card.base; const notes = []; const log = (t)=> notes.push(t);
      notes.push(cardStaticInfo(card));
      if(card.ability) s += (card.ability(pos,ctx,log) || 0);
      if(card.penalty) s += (card.penalty(pos,ctx,log) || 0);

      let extraCls = "";
      if(typeof card.scoreReq === "function"){
        const sr = card.scoreReq(ctx,pos);
        if(!sr.ok){
          notes.push(`<span class="noscore-badge">Sem pontua√ß√£o</span> <span class="req-text">${sr.msg||""}</span>\n(Continua contando para motorista, melhorias e adjac√™ncias)`);
          s = 0; extraCls = "sc";
        }
      }
      if(card.note && card.impacto.includes("durante")) notes.push(`Nota: ${card.note}`);

      rows.push(rowLine(`Assento ${seatNumber(pos)} ‚Äî ${card.nome}`, s, notes.join("\n"), seatNumber(pos), extraCls));
      passengersScore += s;
    }
  }

  const driverPts = scoreDriver(state, ctx);
  const improvBreak=[]; const {score:improvPts, note:improvNote} = scoreImprovements(state, ctx, improvBreak);
  
  const perrenguesBreak = [];
  const {score: perrenguesPts} = scorePerrengues(state, ctx, perrenguesBreak);
  
  const rotasDiariasBreak = [];
  const {score: rotasDiariasPts} = scoreRotasDiarias(state, ctx, rotasDiariasBreak);
  
  const apx = apaixonadosBonus(state, ctx);
  
  const pagodeBonus = grupoPagodeBonus(state, ctx);
  
  const hasIsabel = ctx.existsId("isabel");
  const hasEdio = ctx.existsId("edio");
  let handPenalty = 0;
  let handDetail = "";
  
  if (hasIsabel && hasEdio) {
    handPenalty = state.hand || 0;
    handDetail = `${handPenalty} (+1 por ${handPenalty} carta(s) na m√£o, pois √âdio e Isabel est√£o juntos)`;
  } else if (hasIsabel) {
    handPenalty = 0;
    handDetail = "0 (Isabel presente)";
  } else {
    handPenalty = -(state.hand || 0);
    handDetail = handPenalty ? `${handPenalty} (‚Äì1 por ${Math.abs(handPenalty)} carta(s) na m√£o)` : "0";
  }

  sumPassengersEl.textContent = passengersScore;
  sumDriverEl.textContent = driverPts;
  sumImprovEl.textContent = improvPts;
  sumPerrenguesEl.textContent = perrenguesPts;
  sumRotasDiariasEl.textContent = rotasDiariasPts;
  sumHandEl.textContent = handPenalty;

  const total = passengersScore + driverPts + improvPts + perrenguesPts + rotasDiariasPts + apx.score + pagodeBonus.score + handPenalty;
  totalScoreEl.textContent = total;
  totalScoreEl.className = "v kpi " + (total>0?"good":(total<0?"bad":"neu"));

  const w = []; 
  if(improvNote) w.push(improvNote);
  if(pagodeBonus.note) w.push(pagodeBonus.note);
  if(hasIsabel && state.hand > 0 && !hasEdio) w.push(`Isabel (A Artes√£) presente: cartas na m√£o n√£o descontam pontos.`);
  if(hasIsabel && hasEdio && state.hand > 0) w.push(`√âdio e Isabel juntos: cartas na m√£o valem +1 ponto cada.`);
  if(warnings.length) w.push(...warnings);
  warningsEl.innerHTML = w.length ? `<div class="kpi warn">‚ö† ${w.join("<br>‚ö† ")}</div>` : "";

  const lines = [
    ...rows,
    ...improvBreak.map(x=>rowLine(x.who,x.delta,x.detail)),
    ...perrenguesBreak.map(x=>rowLine(x.who, x.delta, x.detail)),
    ...rotasDiariasBreak.map(x=>rowLine(x.who, x.delta, x.detail)),
    ...(apx.parts||[]).map(x=>rowLine(x.who, x.delta, x.detail)),
  ];
  
  if(pagodeBonus.score > 0){
    lines.push(rowLine("[Grupo de Pagode] Completo!", pagodeBonus.score, "Reuniu os 5 integrantes do Grupo de Pagode!"));
  }
  
  lines.push(rowLine("[M√£o]", handPenalty, handDetail));
  
  EXPLAIN.innerHTML = lines.join("");
  if(currentBusFocus) scrollExplainToSeat(currentBusFocus);
}

function rowLine(name,score,detail,seatId, extraCls=""){
  return `<div class="row ${extraCls}" ${seatId?`id="exp-seat-${seatId}"`:``}>
    <div class="h"><div class="name">${name}</div><div class="score">${
      score>0?`<span class="kpi good">+${score}</span>`: (score<0?`<span class="kpi bad">${score}</span>`:`<span class="kpi neu">${score}</span>`)
    }</div></div>
    ${detail?`<div class="d">${detail}</div>`:""}
  </div>`;
}

function scrollExplainToSeat(n){
  const el=document.getElementById(`exp-seat-${n}`);
  if(el){ el.classList.add("hl"); setTimeout(()=>el.classList.remove("hl"),1200); el.scrollIntoView({behavior:"smooth",block:"nearest"}); }
}

/* ============================
   Desabilitar op√ß√µes no select conforme regras
============================= */
function refreshSeatSelects(){
  const state = collectState();

  GRID.querySelectorAll("select.seat-select").forEach(sel=>{
    const r = +sel.dataset.row, c = +sel.dataset.col;
    const pos = {row:r,col:c};
    const blockedByWilson = isSeatBlockedByWilson(pos);
    const otherHasCobrador = anyCobradorSelected(sel);

    Array.from(sel.options).forEach(opt=>{
      if(!opt.value){ opt.disabled=false; return; }
      const id = opt.value;
      const isDup = getSelectedCardIds().includes(id) && sel.value!==id && !allowDuplicate(id);
      let disable = isDup;

      if(blockedByWilson) disable = true;

      if(!disable){
        const card = findAnyCard(id);
        if(card){
          if(card.isCobrador && otherHasCobrador) disable = true;
          else{
            const {ok} = checkCardAllowedAt(card, pos, state);
            disable = !ok;
          }
        }
      }
      opt.disabled = disable;
    });

    sel.title = blockedByWilson ? "Bloqueado: Wilson ocupa os 2 lugares desta coluna." : "";
    const card = findAnyCard(sel.value);
    const nameEl = sel.parentElement.nextElementSibling;
    if(nameEl) nameEl.textContent = card ? card.nome : " Adicionar ";
  });
}

/* ============================
   Cat√°logo + Busca
============================= */
const catalogContentEl = document.getElementById("catalogContent");
const catalogSearchEl = document.getElementById("catalogSearch");
document.getElementById("clearCatalogSearch").onclick = ()=>{ catalogSearchEl.value = ""; buildCatalog(""); };
catalogSearchEl?.addEventListener("input", ()=> buildCatalog(catalogSearchEl.value));

function norm(s){ return String(s||"").normalize("NFD").replace(/\p{Diacritic}/gu,"").toLowerCase(); }

function cardMatchesFilter(card, q){
  if(!q) return true;
  const nq = norm(q);
  const hay = [
    card.nome,
    card.faixa, card.temper, card.comp,
    card.text || "", card.note || "",
    card.isCobrador ? "cobrador" : card.isApaixonado ? "apaixonado" : "passageiro"
  ].join(" ");
  return norm(hay).includes(nq);
}

function buildCatalog(q){
  const groups = [
    {
      title: "Motoristas", 
      items: DRIVERS.filter(d => d.id), 
      render: d => ({
        name: d.nome,
        pts: "+1 por cada tag",
        tags: d.bonus.join(" ‚Ä¢ "),
        text: "Concede +1 por cada ocorr√™ncia das 3 subcategorias.",
        badges: ["motorista"]
      })
    },
    {
      title: "Melhorias", 
      items: IMPROVEMENTS, 
      render: i => ({
        name: i.nome,
        pts: "+1 por cada tag",
        tags: i.bonus.join(" ‚Ä¢ "),
        text: "Soma +1 por cada ocorr√™ncia nas cartas ativas.",
        badges: ["melhoria"]
      })
    },
    {
      title: "Perrengues (expans√£o)",
      items: PERRENGUES.filter(p => cardMatchesFilter(p, q)), 
      render: p => ({
        name: p.nome,
        pts: "Efeito vari√°vel",
        tags: p.bonus.join(" ‚Ä¢ "),
        text: p.efeito,
        badges: ["exp", "perrengue"]
      })
    },
    {
      title: "Rotas Di√°rias (expans√£o)",
      items: ROTAS_DIARIAS.filter(r => cardMatchesFilter(r, q)), 
      render: r => ({
        name: r.nome,
        pts: `${r.pontos} pts`,
        tags: r.bonus.join(" ‚Ä¢ "),
        text: r.efeito,
        badges: ["exp", "rotadiaria"]
      })
    },
    {
      title: "Passageiros", 
      items: CARD_DB.filter(c => cardMatchesFilter(c, q)), 
      render: c => ({
        name: c.nome,
        pts: `${c.base} pts`,
        tags: `${c.faixa} ‚Ä¢ ${c.temper} ‚Ä¢ ${c.comp}`,
        text: c.text || "",
        badges: [
          c.require ? "req" : "", 
          c.penalty && !c.ability ? "pen" : "", 
          c.ability ? "hab" : ""
        ].filter(Boolean)
      })
    },
    {
      title: "Cobradores (expans√£o)", 
      items: COBRADORES.filter(c => cardMatchesFilter(c, q)), 
      render: c => ({
        name: c.nome,
        pts: "Habilidade",
        tags: "[Cobrador] ‚Ä¢ +2 por tag correspondente",
        text: c.text || "",
        badges: ["exp", "hab"]
      })
    },
    {
      title: "Apaixonados (expans√£o)", 
      items: APAIXONADOS.filter(a => cardMatchesFilter(a, q)), 
      render: a => ({
        name: a.nome,
        pts: `${a.base} pts`,
        tags: `${a.faixa} ‚Ä¢ ${a.temper} ‚Ä¢ ${a.comp} ‚Ä¢ [Apaixonado]`,
        text: a.text || "",
        badges: ["exp", "hab"]
      })
    },
    {
      title: "Estou no Bus√£o (expans√£o)", 
      items: ESTOU_NO_BUSAO.filter(e => cardMatchesFilter(e, q)), 
      render: e => ({
        name: e.nome,
        pts: `${e.base} pts`,
        tags: `${e.faixa} ‚Ä¢ ${e.temper} ‚Ä¢ ${e.comp}`,
        text: e.text || e.note || "",
        badges: ["exp", "estounobusao"]
      })
    },
    {
      title: "Lendas Urbanas (expans√£o)", 
      items: LENDAS_URBANAS.filter(l => cardMatchesFilter(l, q)), 
      render: l => ({
        name: l.nome,
        pts: `${l.base} pts`,
        tags: `${l.faixa} ‚Ä¢ ${l.temper} ‚Ä¢ ${l.comp}`,
        text: l.text || "",
        badges: ["exp", "lenda"]
      })
    },
    {
      title: "Grupo de Pagode (expans√£o)", 
      items: GRUPO_PAGODE.filter(g => cardMatchesFilter(g, q)), 
      render: g => ({
        name: g.nome,
        pts: `${g.base} pts`,
        tags: `${g.faixa} ‚Ä¢ ${g.temper} ‚Ä¢ ${g.comp} ‚Ä¢ [Pagode]`,
        text: g.text || "",
        badges: ["exp", "pagode"]
      })
    }
  ];

  const html = groups.map(g=>{
    const inner = g.items.map(it=>{
      const m = g.render(it);
      const badges = (m.badges||[]).map(b=>{
        const label = b==="exp"?"Expans√£o": b==="req"?"Exig√™ncia": b==="pen"?"Penalidade": b==="hab"?"Habilidade": b==="motorista"?"Motorista": b==="melhoria"?"Melhoria": b==="perrengue"?"Perrengue": b==="rotadiaria"?"Rota Di√°ria": b==="pagode"?"Pagode": b==="lenda"?"Lenda": b==="estounobusao"?"Estou no Bus√£o":b;
        const cls = b==="exp"?"exp": b==="req"?"req": b==="pen"?"pen": b==="hab"?"hab": b==="motorista"?"motorista": b==="melhoria"?"melhoria": b==="perrengue"?"perrengue": b==="rotadiaria"?"rotadiaria": b==="pagode"?"pagode": b==="lenda"?"lenda": b==="estounobusao"?"estounobusao":b;
        return `<span class="badge ${cls}">${label}</span>`;
      }).join("");
      return `<div class="cat-item">
        <div class="cat-head"><div class="cat-name">${m.name}</div><div class="cat-pts">${m.pts}</div></div>
        <div class="cat-tags">${badges} ${m.tags}</div>
        ${m.text?`<div class="cat-text">${m.text}</div>`:""}
      </div>`;
    }).join("");
    return g.items.length > 0 ? `<div class="cat-group"><h3>${g.title}</h3>${inner}</div>` : '';
  }).join("");
  catalogContentEl.innerHTML = html;
}

/* ============================
   Picker (modal de sele√ß√£o)
============================= */
const pickerModal = document.getElementById("pickerModal");
const pickerGrid = document.getElementById("pickerGrid");
const pickerTitle = document.getElementById("pickerTitle");
const pickerSeatLabel = document.getElementById("pickerSeatLabel");
const pickerSearch = document.getElementById("pickerSearch");
const pickerClear = document.getElementById("pickerClear");
const pickerClose = document.getElementById("pickerClose");
let currentSeatNo = null;

function openPickerForSeat(seatNo){
  currentSeatNo = seatNo;
  pickerSeatLabel.textContent = `Assento ${seatNo}`;
  pickerModal.classList.add("open");
  buildPickerGrid("pass", "");
  pickerSearch.value = "";
}

function closePicker(){ pickerModal.classList.remove("open"); currentSeatNo=null; }

pickerClose.onclick = closePicker;
pickerClear.onclick = ()=>{
  if(currentSeatNo){
    const {row,col} = seatNumToRC(currentSeatNo);
    const sel = GRID.querySelector(`select.seat-select[data-row="${row}"][data-col="${col}"]`);
    if(sel){ sel.value=""; sel.dispatchEvent(new Event("change")); }
    closePicker();
  }
};

function buildPickerGrid(tab, q){
  const state = collectState();
  const filter = (c)=> {
    const normText = norm(c.nome + " " + (c.text || "") + " " + (c.note || "") + " " + c.faixa + " " + c.temper + " " + c.comp);
    return normText.includes(norm(q));
  };
  
  let list=[];
  if(tab==="pass") list = CARD_DB.filter(filter);
  else if(tab==="cob" && EXP_COB.checked) list = COBRADORES.filter(filter);
  else if(tab==="apx" && EXP_APX.checked) list = APAIXONADOS.filter(filter);
  else if(tab==="estou" && EXP_ESTOU_NO_BUSAO.checked) list = ESTOU_NO_BUSAO.filter(filter);
  else if(tab==="lendas" && EXP_LENDAS_URBANAS.checked) list = LENDAS_URBANAS.filter(filter);
  else if(tab==="pagode" && EXP_GRUPO_PAGODE.checked) list = GRUPO_PAGODE.filter(filter);
  
  pickerGrid.innerHTML = "";
  list.slice().sort(byName).forEach(card=>{
    const item = document.createElement("div");
    item.className="picker-item";
    item.innerHTML = `<div class="picker-name">${card.nome}</div><div class="picker-tags">${card.faixa||""} ${card.temper||""} ${card.comp||""}</div>`;
    const {row,col} = seatNumToRC(currentSeatNo);
    const check = checkCardAllowedAt(card,{row,col},state);
    if(!check.ok){ item.classList.add("disabled"); item.title=check.reason||""; }
    item.onclick=()=>{
      if(item.classList.contains("disabled")) return;
      const sel = GRID.querySelector(`select.seat-select[data-row="${row}"][data-col="${col}"]`);
      if(sel){ sel.value=card.id; sel.dispatchEvent(new Event("change")); }
      closePicker();
    };
    pickerGrid.appendChild(item);
  });
}

document.querySelectorAll(".pill").forEach(b=>{
  b.onclick=()=>{
    document.querySelectorAll(".pill").forEach(x=>x.classList.remove("act"));
    b.classList.add("act");
    buildPickerGrid(b.dataset.tab,pickerSearch.value);
  };
});

pickerSearch.addEventListener("input", ()=>{
  const tab = document.querySelector(".pill.act")?.dataset.tab || "pass";
  buildPickerGrid(tab,pickerSearch.value);
});

/* ============================
   Ranking (localStorage)
============================= */
function saveScore(){
  const state=collectState();
  const {ctx}=buildCtx(state);
  const total=+totalScoreEl.textContent;
  const entry={
    jogador: playerNameEl.value||"‚Äî",
    motorista: state.driver? state.driver.nome : "‚Äî",
    melhorias: state.improvements.map(i=>i.nome).join(", "),
    score: total
  };
  const arr = JSON.parse(localStorage.getItem("busaoRanking")||"[]");
  arr.push(entry);
  localStorage.setItem("busaoRanking", JSON.stringify(arr));
  renderRanking();
}

function resetRanking(){
  if(confirm("Deseja realmente zerar o ranking?")){
    localStorage.removeItem("busaoRanking");
    renderRanking();
  }
}

function renderRanking(){
  const arr = JSON.parse(localStorage.getItem("busaoRanking")||"[]");
  rankTableBody.innerHTML = arr.map((e,i)=>
    `<tr><td>${i+1}</td><td>${e.jogador}</td><td>${e.motorista}</td><td>${e.melhorias}</td><td class="right">${e.score}</td></tr>`
  ).join("");
}

btnSaveScore.onclick = saveScore;
btnResetRanking.onclick = resetRanking;

/* ============================
   INIT
============================= */
mountLeft();
mountGrid();
mountBusVisual();
buildCatalog("");
renderRanking();
render();

btnClearSeats.onclick = ()=>{
  GRID.querySelectorAll("select.seat-select").forEach(sel=>{ sel.value=""; });
  rebuildSeatSelectOptions();
  refreshSeatSelects();
  render();
};

btnNewRound.onclick = ()=>{
  if(confirm("Deseja limpar toda a configura√ß√£o (motorista, melhorias, assentos) para uma nova pontua√ß√£o?")){
    GRID.querySelectorAll("select.seat-select").forEach(sel=>{ sel.value=""; });
    DRIVER_SEL.value="";
    selectedImprovementIds.clear();
    buildImprovementButtons();
    selectedPerrengueIds.clear();
    if(EXP_PERR.checked) buildPerrengueButtons();
    selectedRotasDiariasIds.clear();
    if(EXP_ROTAS_DIARIAS.checked) buildRotasDiariasButtons();
    playerNameEl.value = "";
    handCountEl.value = "0";
    rebuildSeatSelectOptions();
    refreshSeatSelects();
    renderDriverInfo();
    render();
  }
};
</script>
</body>
</html>